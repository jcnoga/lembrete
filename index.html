const functions = require('@google-cloud/functions-framework');
const admin = require('firebase-admin');
const nodemailer = require('nodemailer');

admin.initializeApp();
const db = admin.firestore();

// CONFIGURAÃ‡ÃƒO DO SEU GMAIL (ROBÃ” DE ENVIO)
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: 'SEU_EMAIL_GMAIL_AQUI@gmail.com',
    pass: 'SUA_SENHA_DE_APP_AQUI' 
  }
});

functions.http('enviarLembretes', async (req, res) => {
  try {
    // 1. Define a data de "AmanhÃ£"
    const hoje = new Date();
    const amanha = new Date(hoje);
    amanha.setDate(amanha.getDate() + 1);
    const dataAlvo = amanha.toISOString().split('T')[0]; // Ex: 2023-10-25

    console.log(`Buscando tarefas para envio de e-mail na data: ${dataAlvo}`);

    // 2. Busca TODAS as tarefas de TODOS os usuÃ¡rios para essa data que querem e-mail
    // Isso requer uma "Collection Group Query" no Firestore (O console vai te dar um link para criar o Ã­ndice se falhar)
    const snapshot = await db.collectionGroup('tasks')
      .where('date', '==', dataAlvo)
      .where('sendEmail', '==', true)
      .where('completed', '==', false)
      .get();

    if (snapshot.empty) {
      console.log('Nenhuma tarefa para notificar.');
      return res.send('Nenhuma tarefa encontrada.');
    }

    // 3. Loop para enviar e-mails
    const promessasEnvio = [];
    
    snapshot.forEach(doc => {
      const task = doc.data();
      const emailDestino = task.emailAddr;

      if (emailDestino) {
        const mailOptions = {
          from: 'Compromisso FÃ¡cil <seu_email@gmail.com>',
          to: emailDestino,
          subject: `ðŸ”” Lembrete: ${task.title} Ã© amanhÃ£!`,
          text: `OlÃ¡!\n\nVocÃª tem um compromisso agendado:\n\nTÃ­tulo: ${task.title}\nHorÃ¡rio: ${task.time}\n\nNÃ£o se esqueÃ§a!`
        };
        promessasEnvio.push(transporter.sendMail(mailOptions));
      }
    });

    await Promise.all(promessasEnvio);
    res.send(`Sucesso! ${promessasEnvio.length} e-mails enviados.`);

  } catch (error) {
    console.error('Erro:', error);
    res.status(500).send(error.message);
  }
});