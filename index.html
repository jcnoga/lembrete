<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Compromisso F√°cil Cloud Pro + ERP (H√≠brido)</title>
    
    <!-- Bibliotecas PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- MANIFEST PWA -->
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004c99;
            --secondary: #00cc99; /* Receitas */
            --bg: #f4f7f6;
            --text: #333;
            --text-light: #777;
            --white: #fff;
            --danger: #e74c3c; /* Despesas */
            --warning: #f39c12;
            --radius: 12px;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

        /* --- TELA DE LOGIN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .auth-box { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .auth-box h2 { color: var(--primary); margin-bottom: 20px; margin-top: 0; }
        .auth-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1rem; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .auth-btn:active { transform: scale(0.98); }
        .auth-link { margin-top: 20px; font-size: 0.9rem; color: var(--primary); text-decoration: underline; cursor: pointer; display: block; }
        .hidden { display: none !important; }

        /* ESTILOS GOOGLE LOGIN */
        .divider { display: flex; align-items: center; margin: 20px 0; color: #ccc; font-size: 0.8rem; }
        .divider span { flex: 1; height: 1px; background: #eee; }
        .divider p { margin: 0 10px; }
        .btn-google {
            background: #fff; color: #333; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            position: relative;
        }
        .btn-google:hover { background: #f9f9f9; }
        .google-icon { width: 18px; height: 18px; }

        /* --- TELA DE BLOQUEIO (EXPIRA√á√ÉO) --- */
        #block-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: white;
            z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center;
        }
        #block-screen h1 { color: var(--danger); }
        
        /* --- APP HEADER --- */
        header { background: var(--white); padding: 15px 20px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .app-name { font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .user-status { font-size: 0.8rem; color: #777; display:flex; align-items: center; gap: 5px; }

        /* --- MAIN CONTAINER --- */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }

        /* --- DASHBOARD WIDGETS --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { background: var(--white); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; }
        .card-stat h3 { font-size: 2rem; color: var(--primary); margin: 0; }
        .card-stat p { font-size: 0.9rem; color: var(--text-light); margin: 0; }
        .welcome-card { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; grid-column: 1 / -1; }
        
        /* --- LISTAS E ITENS --- */
        .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 10px; }
        .section-title h3 { margin: 0; }
        
        /* Estilos Unificados de Itens (Tarefas, Transa√ß√µes, Contatos, Itens) */
        .task-item, .transaction-item, .contact-item, .item-item { 
            background: var(--white); padding: 15px; margin-bottom: 10px; border-radius: var(--radius); 
            display: flex; align-items: center; justify-content: space-between; 
            border-left: 5px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
        }
        
        /* Cores de Borda */
        .task-item.priority-normal { border-left-color: var(--primary); }
        .task-item.done { opacity: 0.6; text-decoration: line-through; border-left-color: var(--secondary); }
        .transaction-item.type-in { border-left-color: var(--secondary); }
        .transaction-item.type-out { border-left-color: var(--danger); }
        .transaction-item.paid { opacity: 0.6; }
        .transaction-item.paid .fin-amount { text-decoration: line-through; }
        
        .contact-item { border-left: 5px solid #ccc; }
        .item-item { border-left: 5px solid #9b59b6; }

        .info-col { flex: 1; padding-right: 10px; cursor: pointer; }
        .main-text { font-weight: 600; font-size: 1rem; margin-bottom: 4px; display: block; }
        .sub-text { font-size: 0.8rem; color: var(--text-light); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        .item-actions { display: flex; gap: 8px; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-light); padding: 4px; }
        .btn-wa { color: #25D366; }

        /* --- ADMIN PANEL --- */
        .admin-box { background: #fff8e1; border: 1px solid #ffe082; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; }
        .admin-box h3 { margin-top: 0; color: #f57f17; }
        .user-list-item { background: white; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }

        /* --- CADASTROS STYLES --- */
        .registers-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .reg-tab { flex: 1; padding: 10px; text-align: center; background: #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #555; transition: 0.2s; }
        .reg-tab.active { background: var(--primary); color: white; }
        .contact-type-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 5px; text-transform: uppercase; }
        .badge-client { background: var(--secondary); }
        .badge-supplier { background: var(--danger); }
        .badge-both { background: var(--primary); }

        /* --- FINANCEIRO --- */
        .fin-summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .fin-card { background: white; padding: 15px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .fin-card h4 { margin: 0; font-size: 0.8rem; color: #777; }
        .fin-card span { font-size: 1.1rem; font-weight: bold; display: block; margin-top: 5px; }
        .text-green { color: var(--secondary); }
        .text-red { color: var(--danger); }
        .fin-amount { font-weight: bold; }

        /* --- CALENDAR --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; text-align: center; }
        .cal-day-header { font-weight: bold; font-size: 0.8rem; color: var(--text-light); padding-bottom: 10px; }
        .cal-day { padding: 10px; background: white; border-radius: 8px; font-size: 0.9rem; position: relative; cursor: pointer; }
        .cal-day.today { background: var(--primary); color: white; }
        .cal-day.has-task::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--danger); border-radius: 50%; }

        /* --- NAVIGATION BAR --- */
        nav { background: var(--white); border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; position: fixed; bottom: 0; width: 100%; z-index: 100; height: 60px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-light); text-decoration: none; font-size: 0.65rem; background: none; border: none; cursor: pointer; flex: 1; }
        .nav-item svg { width: 22px; height: 22px; margin-bottom: 4px; fill: currentColor; }
        .nav-item.active { color: var(--primary); font-weight: 600; }

        /* --- FAB BUTTON --- */
        .fab { position: fixed; bottom: 80px; right: 20px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,102,204,0.4); border: none; cursor: pointer; z-index: 200; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: flex-end; }
        .modal.open { display: flex; animation: slideUp 0.3s ease; }
        .modal-content { background: var(--white); width: 100%; max-width: 600px; padding: 25px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #fff; }
        .btn-block { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #eee; color: var(--text); margin-top: 10px; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; margin-top: 10px; }
        
        /* Checkbox Cloud */
        .cloud-option { background: #eef2ff; padding: 12px; border-radius: 8px; border: 1px solid #ccd5ff; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .cloud-option input { width: 20px; height: 20px; }

        /* CONFIGURA√á√ïES AVAN√áADAS NO MODAL */
        .advanced-settings {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .advanced-settings h4 { margin-top: 0; color: var(--primary); font-size: 0.95rem; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        .col label { font-size: 0.8rem; font-weight: normal; color: #666; }
        .col input { padding: 8px; font-size: 0.9rem; }

        /* --- ALARM MODAL --- */
        .alarm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; }
        .alarm-modal.active { display: flex; animation: fadeIn 0.3s; }
        .alarm-card { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; border-top: 10px solid var(--warning); }
        .alarm-icon { font-size: 3rem; display: block; margin-bottom: 10px; animation: bounce 1s infinite; }
        .alarm-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .filters-box input, .filters-box select { height: 45px; font-size: 0.95rem; }
        .empty-state { padding: 40px 20px; text-align: center; color: var(--text-light); background: #fff; border-radius: var(--radius); margin-top: 10px; border: 1px dashed #ddd; }
        
        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* PIX FOOTER */
        .pix-footer { text-align: center; margin-top: 40px; padding-bottom: 20px; font-size: 0.8rem; color: #ccc; cursor: pointer; transition: color 0.3s; }
        .pix-footer:hover { color: var(--primary); text-decoration: underline; }

        /* PIX GRID BUTTONS */
        .pix-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-pix { padding: 15px; border: 2px solid #f1c40f; background: white; border-radius: 10px; cursor: pointer; font-weight: bold; color: #333; transition: all 0.2s; }
        .btn-pix:active { background: #f1c40f; }
        .pix-key-display { background: #f9f9f9; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem; color: #555; margin-top: 10px; word-break: break-all; user-select: all; }
    </style>
</head>
<body onclick="enableAudio()">

    <!-- TELA DE BLOQUEIO (EXPIRA√á√ÉO) -->
    <div id="block-screen">
        <span style="font-size: 4rem;">üö´</span>
        <h1>Acesso Expirado</h1>
        <p>Seu per√≠odo de utiliza√ß√£o do aplicativo encerrou.</p>
        <p>Para continuar utilizando e n√£o perder seus dados,<br>entre em contato com o suporte.</p>
        <button class="btn-block btn-primary" onclick="window.open('https://wa.me/5500000000000')" style="max-width:300px; margin-top:20px;">Falar com Suporte</button>
        <button onclick="appLogout()" style="background:none; border:1px solid #666; color:#ccc; padding:10px 20px; border-radius:20px; margin-top:20px; cursor:pointer;">Sair / Logout</button>
    </div>

    <!-- 1. TELA DE AUTENTICA√á√ÉO -->
    <div id="auth-screen">
        <div class="auth-box" id="login-form">
            <h2>Compromisso F√°cil</h2>
            <p style="margin-bottom: 20px; color: #666;">Sua agenda na nuvem.</p>
            
            <input type="email" id="log-email" class="auth-input" placeholder="Seu e-mail">
            <input type="password" id="log-pass" class="auth-input" placeholder="Sua senha">
            
            <button class="auth-btn" onclick="appLogin()">Entrar</button>

            <!-- LOGIN COM GOOGLE -->
            <div class="divider">
                <span></span><p>OU</p><span></span>
            </div>
            
            <button class="auth-btn btn-google" onclick="appLoginGoogle()">
                <svg class="google-icon" viewBox="0 0 48 48">
                    <path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                    <path fill="#34A853" d="M46.98 24.46c0-1.66-.15-3.21-.42-4.72H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.48z"></path>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                    <path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                </svg>
                Entrar com Google
            </button>
            
            <div class="auth-link" onclick="toggleAuth('register')">Criar conta nova (E-mail)</div>
            <div class="auth-link" onclick="toggleAuth('reset')" style="color:#ddd;">Esqueci minha senha</div>
        </div>

        <div class="auth-box hidden" id="register-form">
            <h2>Criar Conta</h2>
            <p style="font-size:0.9rem; color:#777;">Preencha para acessar o sistema</p>
            <input type="email" id="reg-email" class="auth-input" placeholder="E-mail">
            <input type="password" id="reg-pass" class="auth-input" placeholder="Senha (min 6)">
            <button class="auth-btn" onclick="appRegister()">Cadastrar</button>
            <div class="auth-link" onclick="toggleAuth('login')">Voltar para Login</div>
        </div>

        <div class="auth-box hidden" id="reset-form">
            <h2>Recuperar Senha</h2>
            <p style="font-size:0.9rem; color:#777; margin-bottom:15px;">Digite seu e-mail para receber o link de redefini√ß√£o.</p>
            <input type="email" id="reset-email" class="auth-input" placeholder="E-mail cadastrado">
            <button class="auth-btn" onclick="appResetPassword()">Enviar Link</button>
            <div class="auth-link" onclick="toggleAuth('login')">Cancelar</div>
        </div>
    </div>

    <!-- 2. APP PRINCIPAL -->
    <div id="app-screen" class="hidden">
        <header>
            <div class="app-name">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                Compromisso F√°cil
            </div>
            <div class="header-actions">
                <!-- √çCONE DE CONFIGURA√á√ïES (SHORTCUT) -->
                <button onclick="switchTab('settings')" style="background:none; border:none; cursor:pointer; font-size:1.3rem; color:var(--text-light);" title="Configura√ß√µes e Backup">‚öôÔ∏è</button>
                
                <div class="user-status">
                    <span id="user-display"></span>
                    <button onclick="appLogout()" style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--danger);" title="Sair">üö™</button>
                </div>
            </div>
        </header>

        <main>
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section">
                <div class="dashboard-grid">
                    <div class="card welcome-card">
                        <h2 id="greeting">Ol√°!</h2>
                        <p>Suas tarefas est√£o sincronizadas na nuvem.</p>
                    </div>
                    <div class="card card-stat">
                        <h3 id="stat-pending">0</h3>
                        <p>Tarefas Pendentes</p>
                    </div>
                    <!-- Clientes (Receita) -->
                    <div class="card card-stat">
                        <h3 id="stat-revenue" style="color: var(--secondary);">R$ 0</h3>
                        <p>A Receber (Total)</p>
                    </div>
                    <!-- Fornecedores (Despesa) -->
                    <div class="card card-stat">
                        <h3 id="stat-expense" style="color: var(--danger);">R$ 0</h3>
                        <p>A Pagar (Total)</p>
                    </div>
                </div>
                <div class="section-title">
                    <h3>Para Hoje</h3>
                    <a href="#" onclick="switchTab('tasks')" style="color:var(--primary); text-decoration:none;">Ver todas</a>
                </div>
                <div id="dashboard-list"></div>

                <!-- BOT√ÉO DE APOIO DISCRETO -->
                <div style="margin-top: 40px; text-align: center;">
                    <button onclick="openSupportModal()" style="background: white; color: var(--primary); border: 2px solid #f1c40f; padding: 10px 25px; border-radius: 50px; font-weight: bold; font-size: 0.9rem; cursor: pointer; box-shadow: var(--shadow);">
                        Apoiar üíõ
                    </button>
                </div>
            </div>

            <!-- VIEW: CALENDAR -->
            <div id="view-calendar" class="view-section hidden">
                <div class="section-title">
                    <h3 id="calendar-month-year">M√™s</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-icon" onclick="changeMonth(-1)">‚óÄ</button>
                        <button class="btn-icon" onclick="changeMonth(1)">‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="cal-day-header">D</div><div class="cal-day-header">S</div><div class="cal-day-header">T</div><div class="cal-day-header">Q</div><div class="cal-day-header">Q</div><div class="cal-day-header">S</div><div class="cal-day-header">S</div>
                </div>
                <div id="calendar-days" class="calendar-grid"></div>
                <div style="margin-top:20px;">
                    <h4>Tarefas do dia:</h4>
                    <div id="calendar-task-list" style="margin-top:10px;">Selecione um dia</div>
                </div>
            </div>

            <!-- VIEW: TASKS -->
            <div id="view-tasks" class="view-section hidden">
                <div class="section-title">
                    <h3>Todas as Tarefas</h3>
                </div>
                
                <!-- Filtros -->
                <div class="filters-box" style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="text" id="task-search" class="form-control" placeholder="üîç Buscar por t√≠tulo..." oninput="renderTasks()" style="flex: 2;">
                    
                    <select id="filter-category" class="form-control" style="flex: 1; padding:5px;" onchange="renderTasks()">
                        <option value="all">Todas</option>
                        <option value="Trabalho">Trabalho</option>
                        <option value="Pessoal">Pessoal</option>
                        <option value="Cliente">Clientes</option>
                        <option value="Fornecedor">Fornecedor</option>
                    </select>
                </div>

                <div id="tasks-list"></div>
            </div>

            <!-- VIEW: FINANCE (M√ìDULO ERP) -->
            <div id="view-finance" class="view-section hidden">
                <div class="section-title">
                    <h3>Financeiro</h3>
                    <button onclick="openFinancialModal()" class="btn-icon" style="color:var(--primary); font-size:1.5rem;">‚ûï</button>
                </div>

                <!-- Resumo Financeiro -->
                <div class="fin-summary">
                    <div class="fin-card">
                        <h4>Saldo Geral</h4>
                        <span id="fin-balance" style="color: var(--primary);">R$ 0,00</span>
                    </div>
                    <div class="fin-card">
                        <h4>A Receber</h4>
                        <span id="fin-total-in" class="text-green">R$ 0,00</span>
                    </div>
                    <div class="fin-card">
                        <h4>A Pagar</h4>
                        <span id="fin-total-out" class="text-red">R$ 0,00</span>
                    </div>
                </div>

                <!-- Filtros Financeiros -->
                <div class="filters-box" style="display:flex; gap:10px; margin-bottom:20px;">
                    <select id="fin-filter-type" class="form-control" onchange="renderFinance()" style="flex:1">
                        <option value="all">Tudo</option>
                        <option value="in">Entradas</option>
                        <option value="out">Sa√≠das</option>
                    </select>
                    <select id="fin-filter-status" class="form-control" onchange="renderFinance()" style="flex:1">
                        <option value="all">Todos Status</option>
                        <option value="pending">Pendentes</option>
                        <option value="paid">Pagos/Recebidos</option>
                    </select>
                </div>

                <div id="finance-list"></div>
            </div>

            <!-- VIEW: REGISTERS (CADASTROS - GRID INTEGRADO) -->
            <div id="view-registers" class="view-section hidden">
                <div class="section-title"><h3>Cadastros (ERP)</h3></div>
                
                <div class="registers-nav">
                    <div class="reg-tab active" id="tab-contacts" onclick="toggleRegisterTab('contacts')">Pessoas (Clientes/Forn.)</div>
                    <div class="reg-tab" id="tab-items" onclick="toggleRegisterTab('items')">Itens (Prod./Serv.)</div>
                </div>

                <!-- Lista de Contatos -->
                <div id="reg-contacts-view">
                    <button class="btn-block btn-primary" onclick="openContactModal()" style="margin-bottom:15px;">+ Nova Pessoa</button>
                    <div id="contacts-list"></div>
                </div>
                
                <!-- Lista de Itens -->
                <div id="reg-items-view" class="hidden">
                    <button class="btn-block btn-primary" onclick="openItemModal()" style="margin-bottom:15px;">+ Novo Item</button>
                    <div id="items-list"></div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="view-section hidden">
                <h3>Mais Op√ß√µes</h3>
                
                <!-- PAINEL ADMINISTRATIVO (S√ì VIS√çVEL PARA O ADMIN) -->
                <div id="admin-panel" class="admin-box hidden">
                    <h3>üëë Painel Administrativo</h3>
                    <p style="font-size:0.8rem; margin-top:0;">Gerenciar validade dos usu√°rios.</p>
                    <div id="admin-user-list">Carregando usu√°rios...</div>
                </div>

                <!-- CONFIGURA√á√ÉO DEFAULT DE ALERTAS -->
                <div class="card" style="margin-top:15px; border:1px solid #cce5ff;">
                    <p style="margin-top:0; color:var(--primary-dark); font-weight:bold;">üõ†Ô∏è Configura√ß√£o Padr√£o de Alertas</p>
                    <p style="font-size:0.8rem; color:#666;">Esses valores ser√£o usados automaticamente em novos registros.</p>
                    
                    <div class="advanced-settings" style="background:white; border:none; padding:0;">
                        <h4 style="font-size:0.8rem;">‚è∞ Alarme (Sonoro)</h4>
                        <div class="row">
                            <div class="col">
                                <label>Iniciar (min antes)</label>
                                <input type="number" id="def-alarm-start" class="form-control" placeholder="15">
                            </div>
                            <div class="col">
                                <label>Repetir (cada min)</label>
                                <input type="number" id="def-alarm-freq" class="form-control" placeholder="5">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>Se atrasado (cada min)</label>
                                <input type="number" id="def-alarm-over-freq" class="form-control" placeholder="10">
                            </div>
                        </div>

                        <h4 style="font-size:0.8rem; margin-top:10px;">üìß E-mail</h4>
                        <div class="row">
                            <div class="col">
                                <label>Iniciar (dias antes)</label>
                                <input type="number" id="def-mail-days" class="form-control" placeholder="1">
                            </div>
                            <div class="col">
                                <label>Repetir (cada dias)</label>
                                <input type="number" id="def-mail-freq" class="form-control" placeholder="1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label>Se atrasado (cada dias)</label>
                                <input type="number" id="def-mail-over-freq" class="form-control" placeholder="1">
                            </div>
                            <div class="col">
                                <label>Max Envios Atrasados</label>
                                <input type="number" id="def-mail-over-max" class="form-control" placeholder="3">
                            </div>
                        </div>
                        <button class="btn-block btn-primary" onclick="saveDefaultSettings()">Salvar Padr√µes</button>
                    </div>
                </div>

                <!-- LIMPEZA AUTOM√ÅTICA (TOGGLE) -->
                <div class="card" style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>Limpeza Autom√°tica</strong>
                        <p style="font-size:0.8rem; color:#777; margin:0;">Excluir lembretes vencidos h√° 30 dias</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="auto-cleanup-check" onchange="toggleCleanup(this)">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="card" style="margin-top:15px;">
                    <p><strong>Gerenciar Dados</strong></p>
                    <button class="btn-block btn-primary" id="btn-force-sync" onclick="forceSync()" style="margin-bottom:10px;">üîÑ For√ßar Sincroniza√ß√£o</button>
                    <button class="btn-block btn-danger" onclick="clearAllCompleted()">üßπ Limpar Tarefas Conclu√≠das</button>
                </div>

                <div class="card" style="margin-top:15px;">
                    <p><strong>Relat√≥rios</strong></p>
                    <button class="btn-block btn-primary" onclick="exportPDF()">üìÑ Baixar Relat√≥rio PDF</button>
                </div>
                
                <!-- √ÅREA DE BACKUP E RESTORE -->
                <div class="card" style="margin-top:15px; border: 2px solid #ddd;">
                    <p><strong>üíæ Backup e Restaura√ß√£o</strong></p>
                    <p style="font-size:0.8rem; color:#666; margin-top:0;">Salve seus dados localmente.</p>
                    <button class="btn-block btn-secondary" onclick="backupData()">üì• Fazer Backup (Baixar)</button>
                    <button class="btn-block btn-secondary" onclick="triggerRestore()">üì§ Restaurar Backup (Enviar)</button>
                    <input type="file" id="restore-input" style="display:none" accept=".json" onchange="restoreData(this)">
                </div>

                <div class="card" style="margin-top:15px;">
                    <p><strong>Conta</strong></p>
                    <p style="font-size:0.8rem; color:#777;">Logado como: <span id="settings-email"></span></p>
                    <button class="btn-block btn-secondary" onclick="appLogout()" style="color:var(--danger)">Sair da Conta</button>
                </div>
                
                <div class="pix-footer" onclick="openSupportModal()">
                    ‚òï Apoie o desenvolvimento (Pix)
                </div>
            </div>
        </main>

        <!-- FAB (Floating Action Button) -->
        <button class="fab" onclick="handleFabClick()">+</button>

        <!-- NAVIGATION BAR (6 √çcones) -->
        <nav>
            <button class="nav-item active" onclick="switchTab('dashboard')" id="nav-dashboard">
                <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>In√≠cio
            </button>
            <button class="nav-item" onclick="switchTab('calendar')" id="nav-calendar">
                <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.89-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.95-2-2.05-2zM5 20V9h14v11H5z"/></svg>Agenda
            </button>
            <button class="nav-item" onclick="switchTab('tasks')" id="nav-tasks">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>Tarefas
            </button>
            <button class="nav-item" onclick="switchTab('finance')" id="nav-finance">
                <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>Finan√ßas
            </button>
             <button class="nav-item" onclick="switchTab('registers')" id="nav-registers">
                <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>Cadastros
            </button>
            <button class="nav-item" onclick="switchTab('settings')" id="nav-settings">
                <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>Mais
            </button>
        </nav>
    </div>

    <!-- 3. MODAIS -->
    <!-- Task Modal (CORRIGIDO) -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0;">Novo Compromisso</h3>
            <input type="hidden" id="t-id">
            
            <div class="form-group">
                <label>T√≠tulo *</label>
                <input type="text" id="t-title" class="form-control" placeholder="Ex: Reuni√£o com Jo√£o">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="t-desc" class="form-control" rows="3" placeholder="Detalhes do lembrete..."></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>Data *</label><input type="date" id="t-date" class="form-control"></div>
                <div class="form-group" style="flex:1"><label>Hora</label><input type="time" id="t-time" class="form-control"></div>
            </div>
            
            <div class="cloud-option">
                <input type="checkbox" id="t-send-email" onchange="toggleEmailInput()">
                <label for="t-send-email">Enviar e-mail de lembrete</label>
            </div>
            
            <!-- BLOCO √öNICO DE EMAIL -->
            <div class="form-group hidden" id="div-email-input">
                <label>E-mail Destino</label>
                <input type="email" id="t-email-addr" class="form-control" placeholder="cliente@email.com">
                <div class="advanced-settings" style="margin-top:10px;">
                    <h4>Config E-mail</h4>
                    <div class="row">
                        <div class="col"><label>Dias Antes</label><input type="number" id="t-mail-days" class="form-control"></div>
                        <div class="col"><label>Repetir (dias)</label><input type="number" id="t-mail-int" class="form-control"></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Atrasado (dias)</label><input type="number" id="t-mail-over-int" class="form-control" placeholder="1"></div>
                        <div class="col"><label>M√°x Envios</label><input type="number" id="t-mail-max" class="form-control" placeholder="3"></div>
                    </div>
                </div>
            </div>

            <!-- Campos ocultos para configura√ß√µes de alarme App -->
            <input type="hidden" id="t-rem-start">
            <input type="hidden" id="t-rem-int">
            <input type="hidden" id="t-rem-over-int">

            <div class="form-group">
                <label>Categoria</label>
                <input type="text" id="t-category" class="form-control" list="cat-suggestions">
                <datalist id="cat-suggestions"><option value="Trabalho"><option value="Pessoal"><option value="Cliente"><option value="Fornecedor"></datalist>
            </div>
            <div class="form-group"><label>Valor R$</label><input type="number" id="t-value" class="form-control" step="0.01"></div>

            <button class="btn-block btn-primary" onclick="saveTask()">Salvar</button>
            <button class="btn-block btn-secondary" onclick="closeModal('taskModal')">Cancelar</button>
        </div>
    </div>

    <!-- Finance Modal -->
    <div class="modal" id="financialModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Lan√ßamento Financeiro</h3>
            <input type="hidden" id="f-id">
            
            <div class="form-group">
                <label>Tipo *</label>
                <select id="f-type" class="form-control" onchange="updateFinanceFormContext()">
                    <option value="in">Entrada (A Receber)</option>
                    <option value="out">Sa√≠da (A Pagar)</option>
                </select>
            </div>

            <div class="form-group"><label>Descri√ß√£o/T√≠tulo *</label><input type="text" id="f-title" class="form-control"></div>
            
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>Valor (R$) *</label><input type="number" id="f-amount" class="form-control" step="0.01"></div>
                <div class="form-group" style="flex:1"><label>Vencimento *</label><input type="date" id="f-date" class="form-control"></div>
            </div>

            <div class="form-group">
                <label id="lbl-contact">Pessoa (Opcional)</label>
                <select id="f-contact" class="form-control"><option value="">-- Selecione --</option></select>
            </div>
            
             <div class="form-group hidden" id="div-item-select">
                <label>Produto/Servi√ßo (Opcional)</label>
                <select id="f-item" class="form-control"><option value="">-- Selecione --</option></select>
            </div>

            <div class="advanced-settings">
                <div class="row">
                    <div class="col" style="display:flex; align-items:center;">
                         <input type="checkbox" id="f-alert-enable" checked style="width:20px; height:20px; margin-right:10px;">
                         <label for="f-alert-enable" style="margin:0;">Ativar Alertas de Vencimento</label>
                    </div>
                </div>
            </div>

            <button class="btn-block btn-primary" onclick="saveFinancial()">Salvar</button>
            <button class="btn-block btn-secondary" onclick="closeModal('financialModal')">Cancelar</button>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Cadastro de Pessoa</h3>
            <input type="hidden" id="c-id">
            <div class="form-group"><label>Nome *</label><input type="text" id="c-name" class="form-control"></div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="c-type" class="form-control">
                    <option value="client">Cliente</option>
                    <option value="supplier">Fornecedor</option>
                    <option value="both">Ambos</option>
                </select>
            </div>
            <div class="form-group"><label>Telefone/Celular</label><input type="tel" id="c-phone" class="form-control"></div>
            <div class="form-group"><label>E-mail</label><input type="email" id="c-email" class="form-control"></div>
            <button class="btn-block btn-primary" onclick="saveContact()">Salvar Pessoa</button>
            <button class="btn-block btn-secondary" onclick="closeModal('contactModal')">Cancelar</button>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Cadastro de Item</h3>
            <input type="hidden" id="i-id">
            <div class="form-group"><label>Nome do Item *</label><input type="text" id="i-name" class="form-control"></div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="i-type" class="form-control">
                    <option value="service">Servi√ßo</option>
                    <option value="product">Produto</option>
                </select>
            </div>
            <div class="form-group"><label>Pre√ßo Padr√£o (R$)</label><input type="number" id="i-price" class="form-control" step="0.01"></div>
            <button class="btn-block btn-primary" onclick="saveItem()">Salvar Item</button>
            <button class="btn-block btn-secondary" onclick="closeModal('itemModal')">Cancelar</button>
        </div>
    </div>
    
    <!-- Admin Edit Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <h3>Definir Validade</h3>
            <p>Usu√°rio: <span id="admin-target-user" style="font-weight:bold;"></span></p>
            <input type="hidden" id="admin-target-uid">
            
            <div class="form-group">
                <label>Dias de Acesso (a partir de hoje)</label>
                <input type="number" id="admin-days" class="form-control" placeholder="Ex: 30">
            </div>
            
            <button class="btn-block btn-primary" onclick="saveUserAccess()">Salvar Permiss√£o</button>
            <button class="btn-block btn-secondary" onclick="closeModal('adminModal')">Cancelar</button>
        </div>
    </div>

    <!-- 4. ALARM MODAL -->
    <div class="alarm-modal" id="alarmModal">
        <div class="alarm-card">
            <input type="hidden" id="alarm-item-id">
            <input type="hidden" id="alarm-item-type"> <!-- task or financial -->
            <span class="alarm-icon">‚è∞</span>
            <div id="alarm-context" style="font-weight:bold; color:var(--danger); margin-bottom:5px;"></div>
            <div class="alarm-title">Aten√ß√£o!</div>
            <div id="alarm-time-display" style="font-size:1.5rem; font-weight:bold; color:var(--primary); margin:10px 0;"></div>
            <p id="alarm-text-display" style="margin-bottom:20px;"></p>
            <button class="btn-block btn-success" onclick="completeFromAlarm()">‚úÖ Concluir / Pagar</button>
            <button class="btn-block btn-secondary" onclick="stopAlarm()">Soneca (Silenciar)</button>
        </div>
    </div>

    <!-- 5. SUPPORT MODAL -->
    <div class="modal" id="supportModal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color:var(--primary); margin-top:0;">Apoie o Projeto ‚òï</h3>
            <p>Este app √© gratuito. Selecione um valor:</p>
            <div class="pix-grid">
                <button class="btn-pix" onclick="generatePixCopyPaste(5)">R$ 5,00</button>
                <button class="btn-pix" onclick="generatePixCopyPaste(10)">R$ 10,00</button>
                <button class="btn-pix" onclick="generatePixCopyPaste(15)">R$ 15,00</button>
                <button class="btn-pix" onclick="copyPixSimpleKey()">Outro Valor</button>
            </div>
            <div id="pix-feedback" style="display:none; color:green; font-weight:bold; margin-bottom:10px;">‚úÖ C√≥digo copiado!</div>
            <div class="pix-key-display" id="pix-display-area" style="display:none;"></div>
            <button class="btn-block btn-secondary" onclick="closeModal('supportModal')">Fechar</button>
        </div>
    </div>

    <!-- AUDIO FILES -->
    <audio id="audioAlert" loop src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAUAAACzAAKCg4PEhIWFxsbHiAgIyMoKCsrLzAwMjI2Njg4Ojw8P0BAQkJERkdHSkpMTk5QUFJTU1dXV1lbW11dYGBiYmRmZmdnaGhqam5ucHBydHR3d3l5e3t9fX6AgIGBgoKFhYiIiouLkJCSkpWWlpiYmZmbm52dnp6goKGhoqKkpKWlpqeoqKmqq6ytrq6wsLGxsrK0tLe3uLi6ur29v8DAwsLGxsnJysrMzM7O0NDS0tTX19jY2dvb3Nzd3d7e4ODi4uPj5eXn5+jo6evr7Ozt7u7w8PHx8vL09PX19vf3+Pj6+vv7/Pz9/f7+/v///wAAAqpLdXJ6AAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB"></audio>
    <audio id="audioDone" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAGAAABuAAKCg4PEhIWFxsbHiAgIyMoKCsrLzAwMjI2Njg4Ojw8P0BAQkJERkdHSkpMTk5QUFJTU1dXV1lbW11dYGBiYmRmZmdnaGhqam5ucHBydHR3d3l5e3t9fX6AgIGBgoKFhYiIiouLkJCSkpWWlpiYmZmbm52dnp6goKGhoqKkpKWlpqeoqKmqq6ytrq6wsLGxsrK0tLe3uLi6ur29v8DAwsLGxsnJysrMzM7O0NDS0tTX19jY2dvb3Nzd3d7e4ODi4uPj5eXn5+jo6evr7Ozt7u7w8PHx8vL09PX19vf3+Pj6+vv7/Pz9/f7+/v///wAAAD5LdXJ6AAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB//uQxAAACkQBOAAAAAEAAAD5AAAAABj3/vT23uAgBPgAPAAAAAAAZAAAAAAAAAAAAAAB"></audio>

<script>
    // ==========================================
    // 1. CONFIGURA√á√ÉO DO FIREBASE
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyBhtwWew_DQNX2TZROUShZz4mjK57pRgQk",
      authDomain: "lembrete-d6c15.firebaseapp.com",
      projectId: "lembrete-d6c15",
      storageBucket: "lembrete-d6c15.firebasestorage.app",
      messagingSenderId: "368296869868",
      appId: "1:368296869868:web:7a2c0a91f57de5d3a90ac9",
      measurementId: "G-JE0QH81JG6"
    };

    firebase.initializeApp(firebaseConfig);

    let auth, db;
    try {
        auth = firebase.auth();
        db = firebase.firestore();
        // Ativar Persist√™ncia (Offline-First)
        db.enablePersistence().catch(err => console.log("Persistence error:", err.code));
    } catch(e) { console.error("Erro Firebase", e); }

    let currentUser = null;
    let appData = { tasks: [], financials: [], contacts: [], items: [] };
    let audioUnlocked = false;
    const ADMIN_EMAIL = "jcnvap@gmail.com";

    // Vari√°veis Globais de Unsubscribe (Para for√ßar sync)
    let unsubTasks = null;
    let unsubFinancials = null;
    let unsubContacts = null;
    let unsubItems = null;

    // Configura√ß√£o Padr√£o de Alertas (Default)
    let defaultConfig = {
        alarmStartMin: 15, alarmFreqMin: 5, alarmOverdueFreq: 10,
        emailDaysBefore: 1, emailFreqDays: 1, emailOverdueFreq: 1, emailOverdueMax: 3
    };

    function enableAudio() {
        if (!audioUnlocked) {
            document.getElementById('audioAlert').load();
            document.getElementById('audioDone').load();
            audioUnlocked = true;
        }
    }

    // ==========================================
    // 2. SISTEMA DE LOGIN & DEFAULTS
    // ==========================================
    if(auth) {
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('user-display').textContent = user.email ? user.email.split('@')[0] : "Usu√°rio Google";
                document.getElementById('settings-email').textContent = user.email;
                
                // --- ADMIN & ACCESS LOGIC ---
                syncUserOnLogin(user); // Sincroniza e-mail no banco
                checkAccessValidity(user);
                
                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadUsersForAdmin();
                } else {
                    document.getElementById('admin-panel').classList.add('hidden');
                }
                // ---------------------------

                const cleanupPref = localStorage.getItem('autoCleanup') === 'true';
                document.getElementById('auto-cleanup-check').checked = cleanupPref;

                loadDefaultSettings();
                
                // SINCRONIZAR TODAS AS COLE√á√ïES
                syncTasks(); 
                syncFinancials();
                syncContacts();
                syncItems();
            } else {
                currentUser = null;
                appData = { tasks: [], financials: [], contacts: [], items: [] };
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('block-screen').style.display = 'none'; // Reseta tela de bloqueio
            }
        });
    }

    // --- L√ìGICA DE VALIDADE E ADMIN ---
    async function checkAccessValidity(user) {
        try {
            const docRef = db.collection('users').doc(user.uid);
            const doc = await docRef.get();
            
            if (doc.exists) {
                const data = doc.data();
                if (data.validUntil) {
                    const validDate = new Date(data.validUntil);
                    if (new Date() > validDate) {
                        document.getElementById('block-screen').style.display = 'flex';
                    }
                } else {
                    setAccessDays(user.uid, 7);
                }
            } else {
                setAccessDays(user.uid, 7);
            }
        } catch (e) {
            console.error("Erro checando validade", e);
        }
    }

    // Fun√ß√£o H√≠brida: Atualiza o User no DB ao Logar (Salva E-mail)
    function syncUserOnLogin(user) {
        db.collection('users').doc(user.uid).set({ 
            email: user.email,
            lastLogin: new Date().toISOString()
        }, { merge: true });
    }

    function loadUsersForAdmin() {
        db.collection('users').get().then(snapshot => {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = '';
            
            if(snapshot.empty) { list.innerHTML = 'Nenhum usu√°rio.'; return; }

            snapshot.forEach(doc => {
                const u = doc.data();
                const uid = doc.id;
                const valid = u.validUntil ? new Date(u.validUntil).toLocaleDateString('pt-BR') : 'Sem data';
                
                // PREFER√äNCIA PELO E-MAIL NA LISTA
                const userIdentifier = u.email ? u.email : `ID: ${uid}`;

                const div = document.createElement('div');
                div.className = 'user-list-item';
                div.innerHTML = `
                    <div>
                        <strong>${userIdentifier}</strong><br>
                        <small>Validade: ${valid}</small>
                    </div>
                    <button class="btn-primary" style="padding:5px 10px; font-size:0.8rem;" onclick="openAdminModal('${uid}', '${userIdentifier}')">Definir</button>
                `;
                list.appendChild(div);
            });
        });
    }

    function openAdminModal(uid, identifier) {
        document.getElementById('admin-target-uid').value = uid;
        document.getElementById('admin-target-user').textContent = identifier;
        document.getElementById('admin-days').value = '';
        openModal('adminModal');
    }

    function saveUserAccess() {
        const uid = document.getElementById('admin-target-uid').value;
        const days = parseInt(document.getElementById('admin-days').value);
        if(!uid || !days) return alert("Preencha os dias");
        
        setAccessDays(uid, days).then(() => {
            alert("Atualizado!");
            closeModal('adminModal');
            loadUsersForAdmin(); // Recarrega lista
        });
    }

    function setAccessDays(uid, days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        return db.collection('users').doc(uid).set({ 
            validUntil: date.toISOString() 
        }, { merge: true });
    }
    // ----------------------------------

    function loadDefaultSettings() {
        const stored = localStorage.getItem('alertConfig');
        if(stored) defaultConfig = JSON.parse(stored);
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        setVal('def-alarm-start', defaultConfig.alarmStartMin);
        setVal('def-alarm-freq', defaultConfig.alarmFreqMin);
        setVal('def-alarm-over-freq', defaultConfig.alarmOverdueFreq);
        setVal('def-mail-days', defaultConfig.emailDaysBefore);
        setVal('def-mail-freq', defaultConfig.emailFreqDays);
        setVal('def-mail-over-freq', defaultConfig.emailOverdueFreq);
        setVal('def-mail-over-max', defaultConfig.emailOverdueMax);
    }

    function saveDefaultSettings() {
        const getInt = (id) => { const el = document.getElementById(id); return el ? parseInt(el.value) : 0; };
        
        defaultConfig = {
            alarmStartMin: getInt('def-alarm-start') || 15,
            alarmFreqMin: getInt('def-alarm-freq') || 5,
            alarmOverdueFreq: getInt('def-alarm-over-freq') || 10,
            emailDaysBefore: getInt('def-mail-days') || 1,
            emailFreqDays: getInt('def-mail-freq') || 1,
            emailOverdueFreq: getInt('def-mail-over-freq') || 1,
            emailOverdueMax: getInt('def-mail-over-max') || 3
        };
        localStorage.setItem('alertConfig', JSON.stringify(defaultConfig));
        alert("Configura√ß√µes padr√£o salvas!");
    }

    function appLogin() {
        const email = document.getElementById('log-email').value;
        const pass = document.getElementById('log-pass').value;
        if(!email || !pass) return alert("Preencha os dados");
        auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
    }
    function appLoginGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => alert(error.message));
    }
    function appRegister() {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        auth.createUserWithEmailAndPassword(email, pass).then(()=>alert("Criado!")).catch(err => alert(err.message));
    }
    function appResetPassword() {
        const email = document.getElementById('reset-email').value;
        auth.sendPasswordResetEmail(email).then(() => { alert("Verifique seu e-mail."); toggleAuth('login'); }).catch(err => alert(err.message));
    }
    function appLogout() { auth.signOut(); }
    function toggleAuth(v) {
        document.querySelectorAll('.auth-box').forEach(e=>e.classList.add('hidden'));
        document.getElementById(v === 'login' ? 'login-form' : v === 'register' ? 'register-form' : 'reset-form').classList.remove('hidden');
    }

    // ==========================================
    // 3. SINCRONIA DE DADOS (CLOUD -> APP) - COM UNLISTEN
    // ==========================================
    function syncTasks() {
        if(unsubTasks) unsubTasks(); // Para o listener anterior
        unsubTasks = db.collection('users').doc(currentUser.uid).collection('tasks').orderBy('date').onSnapshot(snapshot => {
            appData.tasks = [];
            snapshot.forEach(doc => { let t = doc.data(); t.id = doc.id; appData.tasks.push(t); });
            refreshViews(); runAutoCleanup();
        });
    }
    function syncFinancials() {
        if(unsubFinancials) unsubFinancials();
        unsubFinancials = db.collection('users').doc(currentUser.uid).collection('financials').orderBy('dueDate').onSnapshot(snapshot => {
            appData.financials = [];
            snapshot.forEach(doc => { let i = doc.data(); i.id = doc.id; appData.financials.push(i); });
            if(currentView === 'finance') renderFinance();
            if(currentView === 'dashboard') renderDashboard();
        });
    }
    function syncContacts() {
        if(unsubContacts) unsubContacts();
        unsubContacts = db.collection('users').doc(currentUser.uid).collection('contacts').orderBy('name').onSnapshot(snapshot => {
            appData.contacts = [];
            snapshot.forEach(doc => { let c = doc.data(); c.id = doc.id; appData.contacts.push(c); });
            if(currentView==='registers') renderRegisters();
        });
    }
    function syncItems() {
        if(unsubItems) unsubItems();
        unsubItems = db.collection('users').doc(currentUser.uid).collection('items').orderBy('name').onSnapshot(snapshot => {
            appData.items = [];
            snapshot.forEach(doc => { let i = doc.data(); i.id = doc.id; appData.items.push(i); });
            if(currentView==='registers') renderRegisters();
        });
    }

    function forceSync() {
        if(!currentUser) return;
        const btn = document.getElementById('btn-force-sync');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'üîÑ Sincronizando...';
        btn.disabled = true;

        // Reinicia conex√µes
        syncTasks();
        syncFinancials();
        syncContacts();
        syncItems();
        syncUserOnLogin(currentUser);

        setTimeout(() => {
            btn.innerHTML = '‚úÖ Sincronizado';
            setTimeout(() => { 
                btn.innerHTML = originalText; 
                btn.disabled = false; 
            }, 2000);
        }, 1500);
    }

    function getLocalDateStr() {
        const d = new Date();
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().split('T')[0];
    }

    // ==========================================
    // 4. CRUD TASKS (VERS√ÉO BLINDADA)
    // ==========================================
    function saveTask() {
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };

        const rawTitle = getVal('t-title');
        const rawDesc = getVal('t-desc');
        const date = getVal('t-date');

        let finalTitle = rawTitle;
        if (!finalTitle && rawDesc) {
            finalTitle = rawDesc;
        }

        if (!finalTitle || !date) {
            return alert("Por favor, preencha a Data e o T√≠tulo (ou a Descri√ß√£o).");
        }

        const data = {
            title: finalTitle,
            description: rawDesc,
            date: date,
            time: getVal('t-time'),
            category: getVal('t-category'),
            value: getVal('t-value') || '0.00',
            sendEmail: document.getElementById('t-send-email') ? document.getElementById('t-send-email').checked : false,
            emailAddr: getVal('t-email-addr'),
            userId: currentUser.uid,
            completed: false,
            remStart: parseInt(getVal('t-rem-start')) || 15,
            remInt: parseInt(getVal('t-rem-int')) || 5,
            remOverInt: parseInt(getVal('t-rem-over-int')) || 10,
            mailDays: parseInt(getVal('t-mail-days')) || 1,
            mailInt: parseInt(getVal('t-mail-int')) || 1,
            mailOverInt: parseInt(getVal('t-mail-over-int')) || 1,
            mailMax: parseInt(getVal('t-mail-max')) || 3,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const id = getVal('t-id');
        const ref = db.collection('users').doc(currentUser.uid).collection('tasks');
        const action = id ? ref.doc(id).update(data) : ref.add({ ...data, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

        action.then(() => {
            closeModal('taskModal');
        }).catch(err => {
            console.error("Erro ao salvar:", err);
            alert("Erro: " + err.message);
        });
    }

    function deleteTask(id) { if(confirm("Excluir?")) db.collection('users').doc(currentUser.uid).collection('tasks').doc(id).delete(); }
    
    function toggleTask(id, status) {
        if(!status) document.getElementById('audioDone').play().catch(()=>{});
        db.collection('users').doc(currentUser.uid).collection('tasks').doc(id).update({ completed: !status });
    }

    function clearAllCompleted() {
        if(confirm("Limpar tarefas conclu√≠das?")) {
            appData.tasks.filter(t=>t.completed).forEach(t => db.collection('users').doc(currentUser.uid).collection('tasks').doc(t.id).delete());
        }
    }

    // ==========================================
    // 5. CRUD FINANCEIRO
    // ==========================================
    function saveFinancial() {
        const type = document.getElementById('f-type').value;
        const title = document.getElementById('f-title').value;
        const amount = document.getElementById('f-amount').value;
        const date = document.getElementById('f-date').value;
        if(!title || !amount || !date) return alert("Preencha dados obrigat√≥rios");

        const data = {
            type, title, amount: parseFloat(amount), dueDate: date,
            contactId: document.getElementById('f-contact').value || null,
            itemId: document.getElementById('f-item').value || null,
            alertEnabled: document.getElementById('f-alert-enable').checked,
            status: 'pending', userId: currentUser.uid, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastAlarmSent: null
        };

        const id = document.getElementById('f-id').value;
        const ref = db.collection('users').doc(currentUser.uid).collection('financials');
        (id ? ref.doc(id).update(data) : ref.add(data)).then(() => closeModal('financialModal'));
    }

    function deleteFinancial(id) { if(confirm("Excluir?")) db.collection('users').doc(currentUser.uid).collection('financials').doc(id).delete(); }
    
    function toggleFinancialStatus(id, status) {
        const ns = status === 'paid' ? 'pending' : 'paid';
        if(ns === 'paid') document.getElementById('audioDone').play().catch(()=>{});
        db.collection('users').doc(currentUser.uid).collection('financials').doc(id).update({ status: ns });
    }

    function updateFinanceFormContext() {
        const type = document.getElementById('f-type').value;
        const contactSel = document.getElementById('f-contact');
        const itemDiv = document.getElementById('div-item-select');
        const itemSel = document.getElementById('f-item');
        
        document.getElementById('lbl-contact').innerText = type === 'in' ? "Cliente (Opcional)" : "Fornecedor (Opcional)";
        
        const currentContact = contactSel.value;
        contactSel.innerHTML = '<option value="">-- Selecione --</option>';
        appData.contacts.forEach(c => {
            let show = (c.type === 'both') || (type === 'in' && c.type === 'client') || (type === 'out' && c.type === 'supplier');
            if(show) {
                let opt = document.createElement('option');
                opt.value = c.id; opt.text = c.name;
                if(c.id === currentContact) opt.selected = true;
                contactSel.appendChild(opt);
            }
        });

        if(type === 'in') {
            itemDiv.classList.remove('hidden');
            if(itemSel.options.length <= 1) {
                itemSel.innerHTML = '<option value="">-- Selecione --</option>';
                appData.items.forEach(i => {
                    let opt = document.createElement('option');
                    opt.value = i.id; opt.text = `${i.name} (R$ ${i.price})`;
                    itemSel.appendChild(opt);
                });
            }
        } else {
            itemDiv.classList.add('hidden');
            itemSel.value = "";
        }
    }
    
    document.getElementById('f-item').addEventListener('change', function() {
        const item = appData.items.find(i => i.id === this.value);
        if(item && item.price) document.getElementById('f-amount').value = item.price;
    });

    // ==========================================
    // 6. CRUD CADASTROS (CRM)
    // ==========================================
    function saveContact() {
        const name = document.getElementById('c-name').value;
        if(!name) return alert("Nome obrigat√≥rio");
        const data = {
            name, type: document.getElementById('c-type').value,
            phone: document.getElementById('c-phone').value, email: document.getElementById('c-email').value,
            userId: currentUser.uid
        };
        const id = document.getElementById('c-id').value;
        const ref = db.collection('users').doc(currentUser.uid).collection('contacts');
        (id ? ref.doc(id).update(data) : ref.add(data)).then(() => closeModal('contactModal'));
    }
    function deleteContact(id) { if(confirm("Excluir?")) db.collection('users').doc(currentUser.uid).collection('contacts').doc(id).delete(); }

    function saveItem() {
        const name = document.getElementById('i-name').value;
        if(!name) return alert("Nome obrigat√≥rio");
        const data = {
            name, type: document.getElementById('i-type').value,
            price: parseFloat(document.getElementById('i-price').value) || 0,
            userId: currentUser.uid
        };
        const id = document.getElementById('i-id').value;
        const ref = db.collection('users').doc(currentUser.uid).collection('items');
        (id ? ref.doc(id).update(data) : ref.add(data)).then(() => closeModal('itemModal'));
    }
    function deleteItem(id) { if(confirm("Excluir item?")) db.collection('users').doc(currentUser.uid).collection('items').doc(id).delete(); }

    // ==========================================
    // 7. GEST√ÉO DE UI / VIEWS
    // ==========================================
    let currentView = 'dashboard';
    
    function handleFabClick() {
        if (currentView === 'finance') openFinancialModal();
        else if (currentView === 'registers') {
            if(document.getElementById('tab-contacts').classList.contains('active')) openContactModal();
            else openItemModal();
        } else {
            openModal('taskModal');
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-'+tab).classList.add('active');
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
        document.getElementById('view-'+tab).classList.remove('hidden');
        currentView = tab;
        refreshViews();
    }

    function refreshViews() {
        if(currentView === 'dashboard') renderDashboard();
        if(currentView === 'tasks') renderTasks();
        if(currentView === 'calendar') renderCalendar();
        if(currentView === 'finance') renderFinance();
        if(currentView === 'registers') renderRegisters();
    }

    function renderDashboard() {
        const list = document.getElementById('dashboard-list');
        const todayStr = getLocalDateStr();
        const pending = appData.tasks.filter(t => !t.completed);
        document.getElementById('stat-pending').textContent = pending.length;

        let totalIn = 0, totalOut = 0;
        appData.tasks.filter(t=>!t.completed).forEach(t => {
            if(t.category === 'Cliente') totalIn += parseFloat(t.value||0);
            if(t.category === 'Fornecedor') totalOut += parseFloat(t.value||0);
        });
        appData.financials.filter(f=>f.status==='pending').forEach(f => {
            if(f.type === 'in') totalIn += f.amount;
            else totalOut += f.amount;
        });

        document.getElementById('stat-revenue').textContent = `R$ ${totalIn.toFixed(2)}`;
        document.getElementById('stat-expense').textContent = `R$ ${totalOut.toFixed(2)}`;

        const todaysTasks = appData.tasks.filter(t => t.date === todayStr && !t.completed);
        list.innerHTML = '';
        if(!todaysTasks.length) list.innerHTML = '<div class="empty-state">Nada para hoje.</div>';
        else todaysTasks.forEach(t => list.appendChild(createTaskElement(t)));
    }

    function renderTasks() {
        const list = document.getElementById('tasks-list');
        const filterCat = document.getElementById('filter-category').value;
        const searchTerm = document.getElementById('task-search').value.toLowerCase();
        
        let tasks = appData.tasks.filter(t => (filterCat==='all' || t.category===filterCat) && t.title.toLowerCase().includes(searchTerm));
        tasks.sort((a,b) => (a.completed===b.completed) ? (new Date(a.date)-new Date(b.date)) : (a.completed?1:-1));
        
        list.innerHTML = '';
        if(!tasks.length) list.innerHTML = '<div class="empty-state">Vazio.</div>';
        else tasks.forEach(t => list.appendChild(createTaskElement(t)));
    }

    function createTaskElement(t) {
        const div = document.createElement('div');
        div.className = `task-item ${t.completed ? 'done' : ''} priority-normal`;
        const waBtn = `<button class="btn-icon btn-wa" onclick="window.open('https://wa.me/?text=${encodeURIComponent(t.title)}')">üí¨</button>`;
        div.innerHTML = `
            <div class="info-col" onclick="openEditTask('${t.id}')">
                <span class="main-text">${t.sendEmail?'üìß':''} ${t.title}</span>
                <span class="sub-text">üìÖ ${formatDateBR(t.date)} ${t.time||''} ${t.value? ' ‚Ä¢ R$ '+t.value : ''}</span>
            </div>
            <div class="item-actions">
                ${waBtn}
                <button class="btn-icon" onclick="toggleTask('${t.id}', ${t.completed})">${t.completed?'‚Ü©Ô∏è':'‚úÖ'}</button>
                <button class="btn-icon" onclick="deleteTask('${t.id}')" style="color:var(--danger)">üóëÔ∏è</button>
            </div>
        `;
        return div;
    }

    function renderFinance() {
        const list = document.getElementById('finance-list');
        const type = document.getElementById('fin-filter-type').value;
        const status = document.getElementById('fin-filter-status').value;

        let items = appData.financials.filter(i => (type==='all' || i.type===type) && (status==='all' || i.status===status));
        items.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

        let finIn = 0, finOut = 0;
        appData.financials.filter(f=>f.status==='pending').forEach(f => {
            if(f.type==='in') finIn += f.amount; else finOut += f.amount;
        });
        document.getElementById('fin-total-in').textContent = `R$ ${finIn.toFixed(2)}`;
        document.getElementById('fin-total-out').textContent = `R$ ${finOut.toFixed(2)}`;
        document.getElementById('fin-balance').textContent = `R$ ${(finIn-finOut).toFixed(2)}`;

        list.innerHTML = '';
        if(!items.length) list.innerHTML = '<div class="empty-state">Vazio.</div>';
        else items.forEach(i => {
            const div = document.createElement('div');
            div.className = `transaction-item type-${i.type} ${i.status==='paid'?'paid':''}`;
            
            let sub = formatDateBR(i.dueDate);
            if(i.contactId) { const c = appData.contacts.find(x=>x.id===i.contactId); if(c) sub += ` ‚Ä¢ ${c.name}`; }
            if(i.itemId) { const it = appData.items.find(x=>x.id===i.itemId); if(it) sub += ` ‚Ä¢ ${it.name}`; }

            div.innerHTML = `
                <div class="info-col" onclick="openEditFinancial('${i.id}')">
                    <span class="main-text">${i.title}</span>
                    <span class="sub-text">${sub}</span>
                </div>
                <div style="text-align:right; margin-right:10px;">
                    <div class="fin-amount" style="color:${i.type==='in'?'var(--secondary)':'var(--danger)'}">R$ ${i.amount.toFixed(2)}</div>
                    <small>${i.status==='paid'?'Pago':'Pendente'}</small>
                </div>
                <div class="item-actions">
                    <button class="btn-icon" onclick="toggleFinancialStatus('${i.id}','${i.status}')">${i.status==='paid'?'‚Ü©Ô∏è':'‚úÖ'}</button>
                    <button class="btn-icon" onclick="deleteFinancial('${i.id}')" style="color:var(--danger)">üóëÔ∏è</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function renderRegisters() {
        const showContacts = document.getElementById('tab-contacts').classList.contains('active');
        document.getElementById('reg-contacts-view').classList.toggle('hidden', !showContacts);
        document.getElementById('reg-items-view').classList.toggle('hidden', showContacts);

        if(showContacts) {
            const list = document.getElementById('contacts-list'); list.innerHTML = '';
            if(appData.contacts.length === 0) list.innerHTML = '<div class="empty-state">Nenhuma pessoa cadastrada.</div>';
            else appData.contacts.forEach(c => {
                const div = document.createElement('div'); div.className = 'contact-item';
                let badgeClass = c.type === 'supplier' ? 'badge-supplier' : (c.type === 'both' ? 'badge-both' : 'badge-client');
                let typeLabel = c.type === 'supplier' ? 'Fornecedor' : (c.type === 'both' ? 'Ambos' : 'Cliente');
                
                div.innerHTML = `
                    <div class="info-col" onclick="openEditContact('${c.id}')">
                        <span class="main-text">${c.name} <span class="contact-type-badge ${badgeClass}">${typeLabel}</span></span>
                        <span class="sub-text">üìû ${c.phone||'-'} | ‚úâÔ∏è ${c.email||'-'}</span>
                    </div>
                    <button class="btn-icon" onclick="deleteContact('${c.id}')" style="color:var(--danger)">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        } else {
            const list = document.getElementById('items-list'); list.innerHTML = '';
            if(appData.items.length === 0) list.innerHTML = '<div class="empty-state">Nenhum item cadastrado.</div>';
            else appData.items.forEach(i => {
                const div = document.createElement('div'); div.className = 'item-item';
                div.innerHTML = `
                    <div class="info-col" onclick="openEditItem('${i.id}')">
                        <span class="main-text">${i.name}</span>
                        <span class="sub-text">${i.type==='service'?'Servi√ßo':'Produto'} ‚Ä¢ R$ ${i.price.toFixed(2)}</span>
                    </div>
                    <button class="btn-icon" onclick="deleteItem('${i.id}')" style="color:var(--danger)">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        }
    }

    function toggleRegisterTab(t) {
        document.querySelectorAll('.reg-tab').forEach(e => e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        renderRegisters();
    }

    // ==========================================
    // 8. HELPERS DE MODAIS E EDI√á√ÉO (BLINDADOS)
    // ==========================================
    function openModal(id) { 
        const modal = document.getElementById(id);
        if(modal) modal.classList.add('open'); 
        
        if(id==='taskModal'){ 
            const clear = (eid) => { const el = document.getElementById(eid); if(el) el.value = ''; };
            const set = (eid, v) => { const el = document.getElementById(eid); if(el) el.value = v; };

            clear('t-id'); clear('t-title'); clear('t-desc'); 
            clear('t-date'); clear('t-time'); clear('t-value'); clear('t-email-addr');
            
            const chk = document.getElementById('t-send-email');
            if(chk) { chk.checked = false; toggleEmailInput(); }

            set('t-rem-start', defaultConfig.alarmStartMin);
        }
    }
    
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function toggleEmailInput() { 
        const div = document.getElementById('div-email-input');
        const chk = document.getElementById('t-send-email');
        if(div && chk) div.classList.toggle('hidden', !chk.checked); 
    }
    function formatDateBR(d) { return d.split('-').reverse().join('/'); }

    function openEditTask(id) {
        const t = appData.tasks.find(x => x.id === id); 
        if(!t) return;

        const setVal = (eid, val) => { const el = document.getElementById(eid); if(el) el.value = val; };

        setVal('t-id', t.id);
        setVal('t-title', t.title || '');
        setVal('t-desc', t.description || '');
        setVal('t-date', t.date || '');
        setVal('t-time', t.time || '');
        setVal('t-category', t.category || '');
        setVal('t-value', t.value || '');
        setVal('t-email-addr', t.emailAddr || '');
        
        const chk = document.getElementById('t-send-email');
        if(chk) { chk.checked = !!t.sendEmail; toggleEmailInput(); }

        setVal('t-rem-start', t.remStart || defaultConfig.alarmStartMin);
        setVal('t-rem-int', t.remInt || defaultConfig.alarmFreqMin);
        setVal('t-mail-days', t.mailDays || defaultConfig.emailDaysBefore);
        setVal('t-mail-int', t.mailInt || defaultConfig.emailFreqDays);
        setVal('t-mail-over-int', t.mailOverInt || defaultConfig.emailOverdueFreq);
        setVal('t-mail-max', t.mailMax || defaultConfig.emailOverdueMax);

        openModal('taskModal');
    }

    function openFinancialModal() {
        const setVal = (eid, v) => { const el = document.getElementById(eid); if(el) el.value = v; };
        setVal('f-id',''); setVal('f-type','out'); setVal('f-title',''); 
        setVal('f-amount',''); setVal('f-date',''); setVal('f-contact',''); setVal('f-item','');
        updateFinanceFormContext();
        openModal('financialModal');
    }
    function openEditFinancial(id) {
        const i = appData.financials.find(x => x.id === id); if(!i) return;
        const setVal = (eid, v) => { const el = document.getElementById(eid); if(el) el.value = v; };
        
        setVal('f-id', i.id);
        setVal('f-type', i.type);
        updateFinanceFormContext(); 
        
        setTimeout(() => {
            setVal('f-title', i.title);
            setVal('f-amount', i.amount);
            setVal('f-date', i.dueDate);
            if(i.contactId) setVal('f-contact', i.contactId);
            if(i.itemId) setVal('f-item', i.itemId);
        }, 0);
        
        openModal('financialModal');
    }

    function openContactModal() { 
        const clear = (eid) => { document.getElementById(eid).value = ''; };
        clear('c-id'); clear('c-name'); clear('c-phone'); clear('c-email');
        openModal('contactModal'); 
    }
    function openEditContact(id) {
        const c = appData.contacts.find(x => x.id === id);
        document.getElementById('c-id').value = c.id;
        document.getElementById('c-name').value = c.name;
        document.getElementById('c-type').value = c.type;
        document.getElementById('c-phone').value = c.phone;
        document.getElementById('c-email').value = c.email;
        openModal('contactModal');
    }

    function openItemModal() {
        const clear = (eid) => { document.getElementById(eid).value = ''; };
        clear('i-id'); clear('i-name'); clear('i-price');
        openModal('itemModal');
    }
    function openEditItem(id) {
        const i = appData.items.find(x => x.id === id);
        document.getElementById('i-id').value = i.id;
        document.getElementById('i-name').value = i.name;
        document.getElementById('i-type').value = i.type;
        document.getElementById('i-price').value = i.price;
        openModal('itemModal');
    }

    // ==========================================
    // 9. BACKUP, RESTORE, PDF, PIX
    // ==========================================
    function backupData() {
        const full = { tasks: appData.tasks, financials: appData.financials, contacts: appData.contacts, items: appData.items };
        const blob = new Blob([JSON.stringify(full, null, 2)], {type: "application/json"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
        a.download = `backup_completo_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function triggerRestore() { document.getElementById('restore-input').click(); }
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                let ts = Array.isArray(data) ? data : (data.tasks||[]);
                let fs = data.financials||[];
                let cs = data.contacts||[];
                let is = data.items||[];

                if(confirm(`Restaurar ${ts.length} tarefas, ${fs.length} finan√ßas, ${cs.length} contatos, ${is.length} itens?`)) {
                    ts.forEach(x => { delete x.id; db.collection('users').doc(currentUser.uid).collection('tasks').add(x); });
                    fs.forEach(x => { delete x.id; db.collection('users').doc(currentUser.uid).collection('financials').add(x); });
                    cs.forEach(x => { delete x.id; db.collection('users').doc(currentUser.uid).collection('contacts').add(x); });
                    is.forEach(x => { delete x.id; db.collection('users').doc(currentUser.uid).collection('items').add(x); });
                    alert("Restaura√ß√£o iniciada!");
                }
            } catch(er) { alert("Erro arquivo: " + er); }
        };
        reader.readAsText(file); input.value = '';
    }

    function exportPDF() {
        if(!window.jspdf) return alert("Aguarde carregar libs...");
        const doc = new window.jspdf.jsPDF();
        doc.text("Relat√≥rio Geral", 10, 10);
        let y = 20;
        doc.text("Tarefas:", 10, y); y+=10;
        doc.autoTable({ startY: y, head:[['Data','Tarefa','Status']], body:appData.tasks.map(t=>[formatDateBR(t.date),t.title,t.completed?'OK':'Pendente']) });
        y = doc.lastAutoTable.finalY + 20;
        doc.text("Financeiro:", 10, y); y+=10;
        doc.autoTable({ startY: y, head:[['Vencto','T√≠tulo','Tipo','Valor','Status']], body:appData.financials.map(f=>[formatDateBR(f.dueDate),f.title,f.type,f.amount,f.status]) });
        doc.save('relatorio.pdf');
    }

    // PIX GENERATOR
    const PIX_KEY_GLOBAL = "b4648948-d0a8-4402-81f4-8a4047fcf4e5";
    function crc16(str) {
        let crc = 0xFFFF;
        for (let i=0; i<str.length; i++) {
            crc ^= str.charCodeAt(i) << 8;
            for (let j=0; j<8; j++) { if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021; else crc = crc << 1; }
        }
        return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
    }
    function createPixPayload(amount) {
        const format = (id, val) => id + val.length.toString().padStart(2, '0') + val;
        const merchant = format('00','BR.GOV.BCB.PIX') + format('01',PIX_KEY_GLOBAL);
        let p = format('00','01') + format('26',merchant) + format('52','0000') + format('53','986');
        if(amount>0) p += format('54',amount.toFixed(2));
        p += format('58','BR') + format('59','App Compromisso') + format('60','Cidade') + format('62',format('05','***')) + '6304';
        return p + crc16(p);
    }
    function generatePixCopyPaste(amount) {
        const code = createPixPayload(amount);
        navigator.clipboard.writeText(code).then(()=>{
            document.getElementById('pix-feedback').style.display='block';
            document.getElementById('pix-display-area').textContent = code;
            document.getElementById('pix-display-area').style.display='block';
        });
    }
    function copyPixSimpleKey() {
        navigator.clipboard.writeText(PIX_KEY_GLOBAL).then(()=>{ alert("Chave copiada!"); });
    }
    function openSupportModal() { document.getElementById('supportModal').classList.add('open'); }
    
    function toggleCleanup(chk) {
        localStorage.setItem('autoCleanup', chk.checked);
        if(chk.checked) runAutoCleanup();
    }
    function runAutoCleanup() {
        if(localStorage.getItem('autoCleanup') !== 'true') return;
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
        const str = cutoff.toISOString().split('T')[0];
        appData.tasks.filter(t=>t.completed && t.date<str).forEach(t=>db.collection('users').doc(currentUser.uid).collection('tasks').doc(t.id).delete());
        appData.financials.filter(f=>f.status==='paid' && f.dueDate<str).forEach(f=>db.collection('users').doc(currentUser.uid).collection('financials').doc(f.id).delete());
    }

    // ==========================================
    // 10. ALARM & CALENDAR LOOP
    // ==========================================
    setInterval(() => {
        if(!currentUser) return;
        const now = new Date();
        const todayStr = getLocalDateStr();

        appData.tasks.forEach(t => {
            if(t.completed || !t.time) return;
            const target = new Date(`${t.date}T${t.time}:00`);
            const diffMin = (target - now) / 60000;
            const startMin = t.remStart || defaultConfig.alarmStartMin;
            
            let trigger = false;
            let msg = "";

            if(diffMin > 0 && diffMin <= startMin) {
                if(!t.lastAlarmSent || (now - new Date(t.lastAlarmSent) > (t.remInt||5)*60000)) { trigger=true; msg=`Em ${Math.ceil(diffMin)} min`; }
            }
            if(Math.abs(diffMin) < 1) {
                if(!t.lastAlarmSent || (now - new Date(t.lastAlarmSent) > 60000)) { trigger=true; msg="√â AGORA!"; }
            }
            
            if(trigger) {
                triggerAlarm(t.id, 'task', t.title, t.time, msg);
                db.collection('users').doc(currentUser.uid).collection('tasks').doc(t.id).update({lastAlarmSent: now.toISOString()});
            }

            if(t.sendEmail && t.emailAddr) {
                const diffDays = Math.ceil((new Date(t.date+"T00:00") - new Date(todayStr+"T00:00")) / 86400000);
                if(diffDays === (t.mailDays||1) || diffDays===0) {
                     if(!t.lastEmailSent || (new Date() - new Date(t.lastEmailSent) > 86400000)) {
                         sendCloudEmail(t, diffDays===0?"HOJE":"Lembrete");
                     }
                }
            }
        });

        appData.financials.forEach(f => {
            if(f.status==='paid' || f.alertEnabled===false) return;
            const isToday = f.dueDate === todayStr;
            if(isToday) {
                 const target = new Date(`${f.dueDate}T09:00:00`);
                 if(now >= target) {
                     if(!f.lastAlarmSent || f.lastAlarmSent.split('T')[0] !== todayStr) {
                         triggerAlarm(f.id, 'financial', f.title, "Hoje", "VENCIMENTO HOJE");
                         db.collection('users').doc(currentUser.uid).collection('financials').doc(f.id).update({lastAlarmSent: now.toISOString()});
                     }
                 }
            }
        });

    }, 15000);

    function triggerAlarm(id, type, title, time, ctx) {
        document.getElementById('audioAlert').currentTime=0; 
        document.getElementById('audioAlert').play().catch(()=>{});
        
        document.getElementById('alarm-item-id').value = id;
        document.getElementById('alarm-item-type').value = type;
        document.getElementById('alarm-context').textContent = ctx;
        document.getElementById('alarm-time-display').textContent = time;
        document.getElementById('alarm-text-display').textContent = title;
        document.getElementById('alarmModal').classList.add('active');
        
        if(Notification.permission==="granted") new Notification(`${ctx}: ${title}`);
    }

    function stopAlarm() { document.getElementById('alarmModal').classList.remove('active'); document.getElementById('audioAlert').pause(); }
    
    function completeFromAlarm() {
        const id = document.getElementById('alarm-item-id').value;
        const type = document.getElementById('alarm-item-type').value;
        document.getElementById('audioDone').play().catch(()=>{});
        
        if(type === 'task') db.collection('users').doc(currentUser.uid).collection('tasks').doc(id).update({completed:true});
        else db.collection('users').doc(currentUser.uid).collection('financials').doc(id).update({status:'paid'});
        stopAlarm();
    }

    function sendCloudEmail(task, prefix) {
        fetch('https://enviaremailsdiarios-368296869868.southamerica-east1.run.app/send-email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                to: task.emailAddr, subject: `${prefix}: ${task.title}`,
                html: `<h2>${prefix}</h2><p>${task.title}</p><p>${formatDateBR(task.date)} ${task.time||''}</p>`
            })
        }).then(()=>{
            db.collection('users').doc(currentUser.uid).collection('tasks').doc(task.id).update({lastEmailSent: new Date().toISOString()});
        }).catch(e=>console.log(e));
    }

    // CALENDAR LOGIC
    let displayMonth=new Date().getMonth(), displayYear=new Date().getFullYear();
    function changeMonth(o) { displayMonth+=o; if(displayMonth>11){displayMonth=0;displayYear++} if(displayMonth<0){displayMonth=11;displayYear--} renderCalendar(); }
    function renderCalendar() {
        const mNames=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        document.getElementById('calendar-month-year').textContent=`${mNames[displayMonth]} ${displayYear}`;
        const c=document.getElementById('calendar-days'); c.innerHTML='';
        const fd=new Date(displayYear,displayMonth,1).getDay(), ld=new Date(displayYear,displayMonth+1,0).getDate();
        for(let i=0;i<fd;i++) c.appendChild(document.createElement('div'));
        for(let i=1;i<=ld;i++) {
            const dStr=`${displayYear}-${String(displayMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const el=document.createElement('div'); el.className='cal-day'; el.textContent=i;
            if(appData.tasks.some(t=>t.date===dStr && !t.completed)) el.classList.add('has-task');
            if(dStr===new Date().toISOString().split('T')[0]) el.classList.add('today');
            el.onclick=()=>{
                const l=document.getElementById('calendar-task-list'); l.innerHTML='';
                const ts=appData.tasks.filter(t=>t.date===dStr);
                if(!ts.length) l.innerHTML='Nada.'; else ts.forEach(t=>l.appendChild(createTaskElement(t)));
            };
            c.appendChild(el);
        }
    }

    // Init msg
    const h = new Date().getHours();
    document.getElementById('greeting').textContent = h<12?"Bom dia!":h<18?"Boa tarde!":"Boa noite!";
    if("Notification" in window) Notification.requestPermission();
</script>
</body>
</html>