<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRA Milho - IAC 100 (2022)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #2e7d32;
            --light-green: #e8f5e9;
            --highlight-border: #43a047;
            --locked-bg: #e9ecef;
            --soil-brown: #795548;
        }
        body {
            background-color: #f4f6f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* CABEÇALHO E CARDS */
        .header-app {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            padding: 25px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            margin-bottom: 30px;
            background: white;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .section-header {
            background-color: var(--light-green);
            color: var(--primary-green);
            padding: 15px 20px;
            font-weight: 700;
            border-bottom: 2px solid rgba(46, 125, 50, 0.1);
            display: flex;
            align-items: center;
            font-size: 1.1rem;
        }
        .section-header i { margin-right: 12px; }

        /* INPUTS DESTACADOS */
        .form-label {
            font-weight: 600;
            color: #444;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        .form-control, .form-select {
            border: 2px solid #ccc;
            padding: 10px 12px;
            font-size: 1.05rem;
            border-radius: 8px;
            background-color: #fcfcfc;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--highlight-border);
            background-color: #fff;
            box-shadow: 0 0 0 4px rgba(67, 160, 71, 0.2);
        }
        /* CAMPO TRAVADO (DEMO OU READONLY) */
        .demo-locked {
            pointer-events: none;
            background-color: var(--locked-bg) !important;
            opacity: 0.7;
            border-color: #b0b0b0;
            color: #666;
            cursor: not-allowed;
        }

        /* BOTÕES */
        .btn-action {
            padding: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 10px;
            font-size: 1.1rem;
        }

        /* TELA DE AUTENTICAÇÃO */
        .auth-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            overflow-y: auto;
        }
        
        /* MARCA D'ÁGUA */
        .watermark {
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 4rem;
            color: rgba(220, 53, 69, 0.15);
            font-weight: 900;
            border: 8px solid rgba(220, 53, 69, 0.15);
            padding: 20px;
            text-align: center;
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
        }

        /* RESULTADOS */
        .report-box {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            background: #fff;
            border: 2px solid #ced4da;
            padding: 25px;
            border-radius: 10px;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-green);
        }
        .nav-pills .nav-link {
            color: var(--primary-green);
        }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN / AUTORIZAÇÃO -->
    <div id="authScreen" class="auth-overlay">
        <div class="card shadow-lg p-5 border-0" style="max-width: 600px; width: 95%; border-radius: 20px;">
            <div class="text-center mb-4">
                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-seedling fa-3x"></i>
                </div>
                <h2 class="fw-bold text-dark">SRA Milho - IAC 100</h2>
                <p class="text-muted">Acesso Seguro & Rastreável</p>
                
                <!-- Alerta se já houver créditos salvos -->
                <div id="existingCreditsMsg" class="alert alert-success d-none text-start">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <strong>Bem-vindo de volta!</strong><br>
                            Você possui <strong id="savedCreditsCount">0</strong> recomendações salvas.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passo 1: Login -->
            <div id="stepLogin">
                <div class="d-grid gap-3">
                    <button id="btnLogin" class="btn btn-outline-dark btn-lg py-3" onclick="simulateGoogleLogin()">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="24" class="me-2">
                        Entrar com Google
                    </button>
                    
                    <button id="btnUseSaved" class="btn btn-success btn-lg py-3 d-none fw-bold" onclick="useSavedCredits()">
                        <i class="fas fa-play me-2"></i> USAR CRÉDITOS SALVOS
                    </button>
                </div>
                <p class="mt-4 small text-center text-muted">© 2025 Sistema de Recomendação Agronômica</p>
            </div>

            <!-- Passo 2: Código e Validação -->
            <div id="stepCode" style="display: none;">
                <div class="alert alert-warning border-warning shadow-sm">
                    <i class="fas fa-lock me-2"></i> <strong>Atenção:</strong> Código de segurança gerado.<br><br>
                    Envie este código para <strong>websitelogx@gmail.com</strong> ou WhatsApp <strong>(34) 9 9782-4990</strong> e solicite a liberação.
                </div>
                
                <div class="bg-light p-4 rounded-3 text-center mb-4 border border-2">
                    <small class="text-uppercase text-muted fw-bold ls-1">Seu Código de Segurança</small>
                    <h1 class="text-primary fw-bold display-3 m-0" id="displayAuthCode">----</h1>
                </div>

                <div class="row g-2 mb-4">
                    <div class="col-6 d-grid">
                         <a id="btnSendWhatsapp" href="#" target="_blank" class="btn btn-success fw-bold">
                            <i class="fab fa-whatsapp me-2"></i> Enviar Whats
                        </a>
                    </div>
                    <div class="col-6 d-grid">
                        <a id="btnSendEmail" href="#" class="btn btn-secondary fw-bold">
                            <i class="fas fa-envelope me-2"></i> Enviar E-mail
                        </a>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Senha de Liberação</label>
                    <input type="text" id="inputPassword" class="form-control text-center form-control-lg" placeholder="Cole a senha recebida aqui">
                    <div class="form-text text-center small text-muted">A senha contém o código hash + quantidade de créditos.</div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg fw-bold" onclick="validateAccess()">
                        <i class="fas fa-check-circle me-2"></i> VALIDAR ACESSO
                    </button>
                    <button class="btn btn-link text-danger text-decoration-none mt-2" onclick="startUnauthorized()">
                        Continuar sem autorização (Modo Fictício)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="appContainer" style="display: none;">
        
        <header class="header-app sticky-top">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tractor fa-2x me-3"></i>
                    <div style="line-height: 1.2;">
                        <h4 class="m-0 fw-bold">Recomendação Milho</h4>
                        <small style="opacity: 0.9;">Boletim Técnico IAC 100 (2022)</small>
                    </div>
                </div>
                <div>
                    <span class="badge bg-white text-success p-2 shadow-sm me-2">
                        <i class="fas fa-ticket-alt"></i> Créditos: <span id="creditCounter" class="fw-bold fs-6">0</span>
                    </span>
                    <button class="btn btn-sm btn-outline-light" onclick="clearCreditsAndExit()">Sair</button>
                </div>
            </div>
        </header>

        <div class="container mt-4 pb-5">
            
            <!-- ALERTA MODO DEMONSTRAÇÃO / EXEMPLO -->
            <div id="unauthAlert" class="alert alert-danger shadow-sm border-2 border-danger" style="display: none;">
                <div class="d-flex align-items-center">
                    <div class="fs-1 me-3"><i class="fas fa-ban"></i></div>
                    <div>
                        <h5 class="fw-bold m-0" id="alertTitle">MODO DE SIMULAÇÃO</h5>
                        <p class="m-0 small" id="alertMsg">Estes dados são aleatórios e fictícios. O cálculo não consumirá seus créditos.</p>
                    </div>
                </div>
            </div>

            <form id="agronomicForm">
                
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" id="btnAutoFill" class="btn btn-outline-primary fw-bold" onclick="triggerExampleData()">
                        <i class="fas fa-magic me-2"></i> Preencher com Dados de Exemplo
                    </button>
                </div>

                <!-- 1. IDENTIFICAÇÃO -->
                <div class="card card-custom">
                    <div class="section-header"><i class="fas fa-user-tag"></i> 1. Identificação da Amostra</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label class="form-label">Nome do Proprietário</label>
                                <input type="text" class="form-control" id="ownerName" required>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Nome da Propriedade</label>
                                <input type="text" class="form-control" id="propName" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Protocolo</label>
                                <input type="text" class="form-control" id="protocolId">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. SISTEMA DE PRODUÇÃO -->
                <div class="card card-custom">
                    <div class="section-header"><i class="fas fa-chart-line"></i> 2. Sistema de Produção</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Safra</label>
                                <select class="form-select" id="cropSeason">
                                    <option value="verao">Verão (Safra Normal)</option>
                                    <option value="safrinha">Safrinha (2ª Safra) [-20% N e K]</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Expectativa de Produção</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="targetYield" placeholder="Ex: 150" required>
                                    <span class="input-group-text fw-bold">sc/ha</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cultura Anterior</label>
                                <select class="form-select" id="prevCulture">
                                    <option value="milho">Milho (Resteva Incorporada)</option>
                                    <option value="graminea">Gramíneas (Pastagem/Braquiária)</option>
                                    <option value="leguminosa">Leguminosa (Soja/Feijão) ou Pousio</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sistema de Plantio</label>
                                <select class="form-select" id="systemType">
                                    <option value="conv">Convencional / PD Recente</option>
                                    <option value="spd_consolidado">Plantio Direto Consolidado (>5 anos)</option>
                                </select>
                                <div class="form-text small">Afeta a antecipação de adubos.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. ANÁLISE DE SOLO -->
                <div class="card card-custom">
                    <div class="section-header"><i class="fas fa-flask"></i> 3. Dados da Análise de Solo (0-20 cm)</div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            
                            <!-- Física -->
                            <div class="col-12"><h6 class="text-secondary border-bottom pb-2">Física do Solo</h6></div>
                            <div class="col-md-4">
                                <label class="form-label">Teor de Argila (%)</label>
                                <input type="number" class="form-control" id="soilClay" step="0.1" placeholder="Ex: 35" required>
                            </div>
                            
                            <!-- Química -->
                            <div class="col-12 mt-4"><h6 class="text-secondary border-bottom pb-2">Química do Solo</h6></div>
                            <div class="col-md-3">
                                <label class="form-label">P-resina (mg/dm³)</label>
                                <input type="number" class="form-control" id="soilP" step="0.1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">K (mmolc/dm³)</label>
                                <input type="number" class="form-control" id="soilK" step="0.1" oninput="calculateSB()" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ca (mmolc/dm³)</label>
                                <input type="number" class="form-control" id="soilCa" step="0.1" oninput="calculateSB()" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Mg (mmolc/dm³)</label>
                                <input type="number" class="form-control" id="soilMg" step="0.1" oninput="calculateSB()" required>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Na (mmolc/dm³)</label>
                                <input type="number" class="form-control" id="soilNa" value="0" step="0.1" oninput="calculateSB()">
                                <div class="form-text small">Use 0 se não informado.</div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label bg-light rounded px-2 border border-secondary">SB (Calc: Ca+Mg+K+Na)</label>
                                <input type="number" class="form-control bg-light fw-bold" id="soilSB" readonly>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">CTC pH 7 (mmolc/dm³)</label>
                                <input type="number" class="form-control" id="soilCTC" step="0.1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">V% (Saturação)</label>
                                <input type="number" class="form-control" id="soilV" step="0.1" required>
                            </div>

                            <div class="col-md-4 mt-4">
                                <label class="form-label">PRNT do Calcário (%)</label>
                                <input type="number" class="form-control" id="limePRNT" value="80">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid mb-5">
                    <button type="button" id="btnCalculate" class="btn btn-success btn-action shadow" onclick="generateRecommendation()">
                        <i class="fas fa-calculator me-2"></i> CALCULAR E DEBITAR CRÉDITO
                    </button>
                </div>
            </form>

            <!-- RESULTADOS -->
            <div id="resultsSection" style="display: none;">
                <div class="card card-custom border border-2 border-success">
                    <div class="card-body p-4">
                        <h3 class="text-center text-success fw-bold mb-4"><i class="fas fa-clipboard-check"></i> Relatório de Recomendação</h3>
                        
                        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-bold" id="pills-farmer-tab" data-bs-toggle="pill" data-bs-target="#pills-farmer" type="button">Relatório Completo</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-bold" id="pills-tech-tab" data-bs-toggle="pill" data-bs-target="#pills-tech" type="button">Resumo Técnico</button>
                            </li>
                        </ul>

                        <div class="tab-content" id="pills-tabContent">
                            
                            <!-- RELATÓRIO TEXTUAL -->
                            <div class="tab-pane fade show active position-relative" id="pills-farmer">
                                <div class="watermark" id="watermarkResult" style="display:none;">SIMULAÇÃO<br>GRÁTIS</div>
                                <textarea id="finalReportText" class="form-control report-box shadow-sm" rows="25" readonly></textarea>
                                
                                <div class="row mt-4 g-2">
                                    <div class="col-md-6 d-grid">
                                        <button class="btn btn-success fw-bold py-3" onclick="shareWhatsapp()">
                                            <i class="fab fa-whatsapp fa-lg me-2"></i> Enviar por WhatsApp
                                        </button>
                                    </div>
                                    <div class="col-md-6 d-grid">
                                        <button class="btn btn-primary fw-bold py-3" onclick="shareEmail()">
                                            <i class="fas fa-envelope fa-lg me-2"></i> Enviar por E-mail
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- TABELA TÉCNICA -->
                            <div class="tab-pane fade" id="pills-tech">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover align-middle text-center">
                                        <thead class="table-success">
                                            <tr>
                                                <th>Parâmetro</th>
                                                <th>Valor Calculado</th>
                                                <th>Unidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="techTableBody">
                                            <!-- Preenchido via JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="alert alert-info small mt-2">
                                    <i class="fas fa-info-circle"></i> Fonte: Boletim Técnico 100 do IAC (2022).<br>
                                    Cálculo de Calagem: Método da Saturação por Bases (V2=70%).
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- ESTADO DA APLICAÇÃO ---
        let appState = {
            authorized: false,
            credits: 0,
            generatedCode: null,
            emailTarget: 'websitelogx@gmail.com',
            whatsappTarget: '5534997824990',
            isDemo: false,
            isFreeExample: false // Nova flag para controlar exemplos no modo logado
        };

        // --- HELPER ALEATORIEDADE ---
        function getRandom(min, max, decimals = 1) {
            const val = Math.random() * (max - min) + min;
            return parseFloat(val.toFixed(decimals));
        }

        // --- INICIALIZAÇÃO E PERSISTÊNCIA ---
        window.onload = function() {
            const savedCredits = localStorage.getItem('sra_credits_milho');
            if (savedCredits && parseInt(savedCredits) > 0) {
                appState.credits = parseInt(savedCredits);
                document.getElementById('existingCreditsMsg').classList.remove('d-none');
                document.getElementById('savedCreditsCount').innerText = appState.credits;
                document.getElementById('btnLogin').classList.add('d-none');
                document.getElementById('btnUseSaved').classList.remove('d-none');
            }
        };

        function calculateSB() {
            const ca = parseFloat(document.getElementById('soilCa').value) || 0;
            const mg = parseFloat(document.getElementById('soilMg').value) || 0;
            const k = parseFloat(document.getElementById('soilK').value) || 0;
            const na = parseFloat(document.getElementById('soilNa').value) || 0;
            
            const sb = ca + mg + k + na;
            document.getElementById('soilSB').value = sb.toFixed(2);
        }

        // --- SISTEMA DE ACESSO ---
        function useSavedCredits() {
            appState.authorized = true;
            appState.isDemo = false;
            unlockApp();
        }

        function simulateGoogleLogin() {
            const btn = document.getElementById('btnLogin');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Conectando...';
            btn.disabled = true;
            
            setTimeout(() => {
                document.getElementById('stepLogin').style.display = 'none';
                document.getElementById('stepCode').style.display = 'block';
                
                appState.generatedCode = Math.floor(Math.random() * 9000) + 1000;
                document.getElementById('displayAuthCode').innerText = appState.generatedCode;
                
                const hashEsperado = (appState.generatedCode + 13) * 9 + 1954;
                console.clear();
                console.log(`SENHA DEBUG: ${hashEsperado}10`);

                const subject = `Solicitação App Milho - Cód: ${appState.generatedCode}`;
                const body = `Olá, solicito código de liberação.\nMeu código de segurança: ${appState.generatedCode}`;
                const wppMsg = `Olá, solicito liberação do App Milho IAC.\nCódigo de Segurança: *${appState.generatedCode}*`;
                
                document.getElementById('btnSendEmail').setAttribute('href', `mailto:${appState.emailTarget}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
                document.getElementById('btnSendWhatsapp').setAttribute('href', `https://wa.me/${appState.whatsappTarget}?text=${encodeURIComponent(wppMsg)}`);
            }, 1500);
        }

        function validateAccess() {
            const inputClean = document.getElementById('inputPassword').value.replace(/\D/g, ''); 
            if (inputClean.length < 6) {
                alert('Senha inválida. Certifique-se de copiar o número completo enviado.');
                return;
            }

            const inputHash = parseInt(inputClean.substring(0, 5));
            const inputCredits = parseInt(inputClean.substring(5));
            const expectedHash = (appState.generatedCode + 13) * 9 + 1954;

            if (inputHash === expectedHash && inputCredits > 0) {
                appState.authorized = true;
                appState.credits = inputCredits;
                appState.isDemo = false;
                localStorage.setItem('sra_credits_milho', appState.credits);
                unlockApp();
            } else {
                alert('Senha incorreta para este código de segurança.');
            }
        }

        function startUnauthorized() {
            appState.authorized = false;
            appState.credits = 0;
            appState.isDemo = true;
            unlockApp();
            
            // Exibir alerta de Demo
            const alertBox = document.getElementById('unauthAlert');
            alertBox.style.display = 'block';
            document.getElementById('alertTitle').innerText = "MODO DEMONSTRAÇÃO - ACESSO NÃO AUTORIZADO";
            document.getElementById('alertMsg').innerText = "Dados aleatórios e travados. O cálculo é apenas uma simulação visual.";

            document.getElementById('watermarkResult').style.display = 'block';
            document.getElementById('btnAutoFill').style.display = 'none'; // Esconde botão de exemplo pois já é tudo exemplo
            
            // Gera e trava dados
            fillFictitiousData(true, true);
        }

        function unlockApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateCreditDisplay();
        }

        function updateCreditDisplay() {
            const display = document.getElementById('creditCounter');
            if(appState.isDemo) {
                display.innerText = "DEMO";
                display.parentElement.className = "badge bg-danger p-2 shadow-sm me-2";
            } else {
                display.innerText = appState.credits;
            }
        }

        function clearCreditsAndExit() {
            location.reload();
        }

        // --- LÓGICA DO BOTÃO "PREENCHER EXEMPLO" (Mesmo logado) ---
        function triggerExampleData() {
            // Marca como exemplo grátis
            appState.isFreeExample = true;
            
            // Exibe marca d'água de simulação
            document.getElementById('watermarkResult').style.display = 'block';
            document.getElementById('watermarkResult').innerHTML = "SIMULAÇÃO<br>GRÁTIS";

            // Preenche com dados aleatórios (true) e trava os campos (true)
            fillFictitiousData(true, true);

            // Altera visual do botão de calcular
            const btnCalc = document.getElementById('btnCalculate');
            btnCalc.classList.remove('btn-success');
            btnCalc.classList.add('btn-warning');
            btnCalc.innerHTML = '<i class="fas fa-calculator me-2"></i> SIMULAR (GRÁTIS)';

            // Mostra aviso visual
            const alertBox = document.getElementById('unauthAlert');
            alertBox.style.display = 'block';
            alertBox.classList.remove('alert-danger');
            alertBox.classList.add('alert-warning');
            document.getElementById('alertTitle').innerText = "DADOS DE EXEMPLO";
            document.getElementById('alertMsg').innerText = "Amostra gerada aleatoriamente para teste. Não será cobrado crédito.";
        }

        // --- GERAÇÃO DE DADOS ---
        function fillFictitiousData(lock, isRandom) {
            const set = (id, val) => document.getElementById(id).value = val;
            
            // Agora sempre gera aleatório se isRandom=true, o que é o caso do botão "Exemplo" e do "Demo Mode"
            if (isRandom) {
                set('ownerName', 'Agricultor Teste ' + Math.floor(Math.random()*1000));
                set('propName', 'Sítio Aleatório ' + String.fromCharCode(65+Math.random()*25));
                set('protocolId', 'SIM-' + Math.floor(Math.random()*9999));
                set('cropSeason', Math.random() > 0.5 ? 'verao' : 'safrinha');
                set('targetYield', Math.floor(getRandom(80, 180)));
                set('prevCulture', Math.random() > 0.5 ? 'graminea' : 'milho');
                set('systemType', Math.random() > 0.5 ? 'spd_consolidado' : 'conv');
                
                // Solos aleatórios
                set('soilClay', getRandom(15, 75));
                set('soilP', getRandom(4, 50));
                set('soilK', getRandom(0.5, 4.0));
                set('soilCa', getRandom(10, 45));
                set('soilMg', getRandom(2, 12));
                set('soilNa', getRandom(0, 0.5));
                set('soilCTC', getRandom(40, 120));
                set('soilV', getRandom(20, 85));
                set('limePRNT', Math.floor(getRandom(70, 100)));
            }
            
            calculateSB();

            if(lock) {
                const form = document.getElementById('agronomicForm');
                const inputs = form.querySelectorAll('input, select');
                inputs.forEach(el => {
                    el.readOnly = true;
                    el.classList.add('demo-locked');
                    if(el.tagName === 'SELECT') el.disabled = true;
                });
            }
        }

        // --- MOTOR DE CÁLCULO (IAC 100 - 2022) ---
        function generateRecommendation() {
            // LÓGICA DE COBRANÇA
            // Só cobra se: Estiver autorizado E NÃO for demo E NÃO for exemplo grátis
            let shouldCharge = appState.authorized && !appState.isDemo && !appState.isFreeExample;

            if(shouldCharge) {
                if(appState.credits <= 0) {
                    alert("Seus créditos acabaram. Reinicie o aplicativo para solicitar mais.");
                    return;
                }
                appState.credits--;
                localStorage.setItem('sra_credits_milho', appState.credits);
                updateCreditDisplay();
            } else {
                // Se for gratuito (Demo ou Exemplo), não faz nada com o crédito
            }

            // 1. Coleta de Dados
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            const inputs = {
                owner: document.getElementById('ownerName').value,
                prop: document.getElementById('propName').value,
                season: document.getElementById('cropSeason').value, 
                yield: getVal('targetYield'),
                prevCult: document.getElementById('prevCulture').value,
                sysType: document.getElementById('systemType').value,
                clay: getVal('soilClay'),
                P: getVal('soilP'),
                K: getVal('soilK'),
                Ca: getVal('soilCa'),
                Mg: getVal('soilMg'),
                CTC: getVal('soilCTC'),
                V: getVal('soilV'),
                PRNT: getVal('limePRNT') || 100
            };

            // 2. Classificação Textura
            let textureClass = "";
            if(inputs.clay <= 20) textureClass = "arenosa";
            else if(inputs.clay <= 60) textureClass = "media";
            else textureClass = "argilosa";

            // 3. Calagem (NC)
            let nc = 0;
            const V2 = 70;
            if(inputs.V < V2) {
                nc = ((V2 - inputs.V) * inputs.CTC) / (inputs.PRNT * 10);
            }
            nc = Math.max(0, nc);
            
            let limeType = (inputs.Mg >= 5) ? "Calcítico" : "Dolomítico ou Magnesiano";
            let limeDesc = (inputs.Mg < 5) ? `Aplicar Calcário ${limeType} (Teor Mg < 5 mmolc/dm³)` : `Pode-se usar Calcário ${limeType}`;

            // 4. Fósforo (P2O5)
            let recP = 0;
            if(textureClass === "arenosa") {
                if(inputs.P <= 10) recP = 80; else if(inputs.P <= 20) recP = 60; else if(inputs.P <= 30) recP = 40; else recP = 20;
            } else if(textureClass === "media") {
                if(inputs.P <= 10) recP = 100; else if(inputs.P <= 20) recP = 80; else if(inputs.P <= 30) recP = 60; else recP = 40;
            } else { 
                if(inputs.P <= 10) recP = 120; else if(inputs.P <= 20) recP = 100; else if(inputs.P <= 30) recP = 80; else recP = 60;
            }

            // 5. Potássio (K2O)
            let recK = 0;
            if(textureClass === "arenosa") {
                if(inputs.K <= 0.8) recK = 80; else if(inputs.K <= 1.5) recK = 60; else if(inputs.K <= 2.5) recK = 40; else recK = 20;
            } else if(textureClass === "media") {
                if(inputs.K <= 1.0) recK = 100; else if(inputs.K <= 2.0) recK = 80; else if(inputs.K <= 3.5) recK = 60; else recK = 40;
            } else { 
                if(inputs.K <= 1.2) recK = 120; else if(inputs.K <= 2.5) recK = 100; else if(inputs.K <= 4.5) recK = 80; else recK = 60;
            }

            // 6. Nitrogênio (N)
            let recN = 0;
            const highYield = inputs.yield > 100;
            if(inputs.prevCult === "milho") recN = highYield ? 80 : 60;
            else if(inputs.prevCult === "graminea") recN = highYield ? 100 : 80;
            else recN = highYield ? 60 : 40;

            // 7. Ajuste Safrinha
            let warningSafrinha = "";
            if(inputs.season === "safrinha") {
                recN *= 0.8; recK *= 0.8;
                warningSafrinha = "(Valores de N e K reduzidos em 20% para Safrinha)";
            }

            // 8. Fontes
            let mapKg = recP / 0.52; 
            let nFromMap = mapKg * 0.11;
            let remainingN = Math.max(0, recN - nFromMap);
            let ureaKg = remainingN / 0.45; 
            let kKCl = recK / 0.60;
            let kSulco = 0, kCob1 = 0, kCob2 = 0;

            if(textureClass === "arenosa") {
                kSulco = kKCl / 3; kCob1 = kKCl / 3; kCob2 = kKCl / 3;
            } else {
                kSulco = kKCl / 2; kCob1 = kKCl / 2;
            }

            let gessoTon = (inputs.clay * 50) / 1000;

            // Textos
            let microText = `Zinco (Zn): 300-400 g/ha\nBoro (B): 150-200 g/ha`;
            let orgText = `Esterco de Curral: 15-20 t/ha ou Aves: 4-6 t/ha`;

            let demoMsg = (appState.isDemo || appState.isFreeExample) ? "*** SIMULAÇÃO COM DADOS FICTÍCIOS - NÃO VÁLIDO PARA USO AGRONÔMICO ***\n" : "";
            const dateStr = new Date().toLocaleDateString('pt-BR');

            let report = `
${demoMsg}
=== RECOMENDAÇÃO AGRONÔMICA MILHO (IAC 100) ===
Data: ${dateStr}
Propriedade: ${inputs.prop} | Produtor: ${inputs.owner}
Safra: ${inputs.season.toUpperCase()} | Meta: ${inputs.yield} sc/ha
Solo: ${inputs.clay}% Argila (${textureClass.toUpperCase()})

1. CORREÇÃO DO SOLO (CALAGEM)
--------------------------------------------------
Necessidade (NC): ${nc.toFixed(1)} t/ha
Recomendação: ${limeDesc}
Meta: Elevar V% a 70% e Mg > 5 mmolc/dm³.

2. GESSAGEM
--------------------------------------------------
Dose Estimada: ${gessoTon.toFixed(1)} t/ha

3. ADUBAÇÃO MINERAL (N-P-K)
--------------------------------------------------
> N: ${recN.toFixed(0)} kg/ha ${warningSafrinha}
> P2O5: ${recP} kg/ha
> K2O: ${recK.toFixed(0)} kg/ha ${warningSafrinha}

SUGESTÃO DE MANEJO:
A) PLANTIO
   > MAP: ${Math.round(mapKg)} kg/ha
   > KCl: ${Math.round(kSulco)} kg/ha

B) COBERTURA
   > Ureia Total: ${Math.round(ureaKg)} kg/ha
   > KCl Restante: ${Math.round(kKCl - kSulco)} kg/ha
   
   Aplicação:
   - V4-V6: ${textureClass === 'arenosa' ? '50% do N, 1/3 do K' : '100% do N, Restante do K'}
   ${textureClass === 'arenosa' ? '- V8-V10: 50% do N, 1/3 do K' : ''}

4. MICRONUTRIENTES
--------------------------------------------------
${microText}

5. ORGÂNICA
--------------------------------------------------
${orgText}

--------------------------------------------------
Responsável Técnico: _________________________
Gerado por SRA
`;

            // Renderizar
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('finalReportText').value = report.trim();
            
            const tbody = document.getElementById('techTableBody');
            tbody.innerHTML = `
                <tr><td>Soma de Bases</td><td>${document.getElementById('soilSB').value}</td><td>mmolc/dm³</td></tr>
                <tr><td>Calagem</td><td>${nc.toFixed(1)}</td><td>t/ha</td></tr>
                <tr><td>Gesso</td><td>${gessoTon.toFixed(1)}</td><td>t/ha</td></tr>
                <tr><td>N Total</td><td>${recN.toFixed(0)}</td><td>kg/ha</td></tr>
                <tr><td>P2O5</td><td>${recP}</td><td>kg/ha</td></tr>
                <tr><td>K2O</td><td>${recK.toFixed(0)}</td><td>kg/ha</td></tr>
            `;

            document.getElementById('resultsSection').scrollIntoView({behavior: 'smooth'});
        }

        // --- EXPORTAR ---
        function shareWhatsapp() {
            const txt = document.getElementById('finalReportText').value;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }
        function shareEmail() {
            const txt = document.getElementById('finalReportText').value;
            const subj = `Recomendação Milho - ${document.getElementById('ownerName').value}`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(txt)}`;
        }

    </script>
</body>
</html>